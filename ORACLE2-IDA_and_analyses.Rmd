---
title: "ORACLE2"
author: "Fleur L. Meulmeester, PhD student"
date: ' Last update : `r Sys.Date()`<br><br>'
output:
  html_document:
    theme: united
    df_print: paged
    toc: yes
    number_sections: no
  pdf_document:
    toc: yes
subtitle: IDA and Statistical analysis
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<style>
body {
text-align: justify}
</style>

<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

<style type="text/css">
.main-container {
  max-width: 1600px;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Installation of packages
 
```{r Packages, eval = FALSE, results = 'hide'}

r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)

# Define a vector of packages used throughout the analysis
Packages <- c("readstata13", "readxl", "dplyr", "tidyverse", "data.table", "ggplot2", "car", "epiDisplay", "lubridate", "table1", "mice", "VIM", "caret", "lsr", "tidymodels", "sjPlot", "stargazer", "Gmisc", "purrr", "corrplot", "ggcorrplot", "Hmisc","naniar","lme4", "MASS", "broom","nnet", "pROC", "rms", "gridExtra", "survival", "ggsurvfit", "survminer", "fmsb", "DescTools")

# Load all necessary libraries
lapply(Packages, library, character.only = TRUE)

```


# Data import

```{r, eval = FALSE}
# Set your working directory
setwd("Network:/Folder/Folder")
```

```{r, eval = FALSE}
# Specify column types for data import, or let R guess the column type
col_types <- c("guess", "guess", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "guess", "text", "text", "text", "text", "text", "text", "text", "text", "text", "numeric", "text", "numeric", "text", "numeric", "text", "guess", "text", "text", "text", "text", "text", "text", "text","guess", "text", "text", "text", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "guess","guess", "text", "guess", "guess", "guess", "guess", "guess", "guess", "guess", "text", "guess", "guess", "guess", "guess", "text", "text", "text", "text", "text", "text") 

# Read data from Excel, specifying the sheet and column types
data_ORACLE <- suppressWarnings(read_excel("data.xlsx", sheet = "sheet", col_types = col_types))
```


# Data cleaning

```{r, eval = FALSE}
# Remove variables that will not be used in the analysis
data_ORACLE <- data_ORACLE[,!names(data_ORACLE) 
                           %in% 
                             c("Arm_included_0no1yes", 
                               "AGE_included", 
                               "Non-missing-EosANDFeNO",
                               "Non-missing_FUP", 
                               "Non-missing_EA", 
                               "Included", 
                               "Included_in_dataset_6516", 
                               "Included_in_dataset_6513")]
```

```{r, eval = FALSE}
# Studies PACT, QUEST and DRI12544 coded the number of attacks as 9999 when no attacks occured
# Recode 9999 to 0 for outcome variable in these specific studies indicating no attacks during follow-up
data_ORACLE <- data_ORACLE %>%
  mutate(Number_severe_asthma_attacks_during_followup = 
           if_else(Enrolled_Trial_name %in% c("PACT", "QUEST", "DRI12544") & 
                     Number_severe_asthma_attacks_during_followup == 9999, 0, Number_severe_asthma_attacks_during_followup))
```

```{r, eval = FALSE}
# In all other studies, 9999 was coded as missig value
# Recode missing values (9999 or "9999") to NA
data_ORACLE[data_ORACLE == 9999] <- NA
summary(data_ORACLE$Blood_Eos_baseline_x10_9_cells_per_L) # Verify recoding for numeric columns

data_ORACLE[data_ORACLE == "9999"] <- NA
unique(data_ORACLE$LABA_prescribed_0no_1yes) # Verify recoding for text columns

```

```{r, eval = FALSE}
# Replace values of 0 in variables that will be log-transformed, using specific minimum values

## Replace value=0 for Blood Eosinophils (BEC)
head(sort(data_ORACLE$Blood_Eos_baseline_x10_9_cells_per_L), n=50) # Identify smallest non-zero value

data_ORACLE <- data_ORACLE %>%
  mutate(Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced = 
           case_when(Blood_Eos_baseline_x10_9_cells_per_L == 0 ~ 0.000185, # Use a value equal to 1/2 of the smallest non-zero value
                     Blood_Eos_baseline_x10_9_cells_per_L > 0 ~ Blood_Eos_baseline_x10_9_cells_per_L), 
         .after = Blood_Eos_baseline_x10_9_cells_per_L)

head(sort(data_ORACLE$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced)) # Verify replacement

## Replace value=0 for FeNO
head(sort(data_ORACLE$FeNO_baseline_ppb)) # Identify smallest non-zero value

data_ORACLE <- data_ORACLE %>%
  mutate(FeNO_baseline_ppb = 
           case_when(FeNO_baseline_ppb == 0 ~ 1.05, # Use a value equal to 1/2 of the smallest non-zero value
                     FeNO_baseline_ppb > 0 ~ FeNO_baseline_ppb))

head(sort(data_ORACLE$FeNO_baseline_ppb)) # Verify replacement
```

```{r, eval = FALSE}
# Variable Total IgE had one character value of "<2.0"
# Convert Total IgE value of <2.0 to "1"
data_ORACLE$Total_IgE <- replace(data_ORACLE$Total_IgE, data_ORACLE$Total_IgE == "<2.0", "1")

# Check and convert Total IgE to numeric variable for further analyses
sum(is.na(data_ORACLE$Total_IgE))
data_ORACLE$Total_IgE = as.numeric(data_ORACLE$Total_IgE)
sum(is.na(data_ORACLE$Total_IgE)) # Ensure no new NAs were introduced
```

```{r, eval = FALSE, warning = FALSE}
# FEV1 % Reversibility and Adherence in Trial are not always percentages
## Check which trials did not code these variables as percentages
summary_table_FEV1r <- data_ORACLE %>%
  dplyr::group_by(Enrolled_Trial_name) %>%
  dplyr::summarize(
    min_FEV1r = min(FEV1_PCT_reversibility_postBD, na.rm = TRUE),
    max_FEV1r = max(FEV1_PCT_reversibility_postBD, na.rm = TRUE)) # STATOS 1 and 2

summary_table_adh <- data_ORACLE %>%
  dplyr::group_by(Enrolled_Trial_name) %>%
  dplyr::summarize(
    min_adh = min(Adherence_InTrial_quantity, na.rm = TRUE),
    max_adh = max(Adherence_InTrial_quantity, na.rm = TRUE)) # CAPTAIN
```

```{r, eval = FALSE}
# Convert FEV1 % Reversibility to percentage format for specific trials
summary(data_ORACLE$FEV1_PCT_reversibility_postBD)
sum(is.na(data_ORACLE$FEV1_PCT_reversibility_postBD))

data_ORACLE <- data_ORACLE %>%
  mutate(FEV1_PCT_reversibility_postBD = 
           if_else(Enrolled_Trial_name %in% 
                     c("STRATOS_1", "STRATOS_2"), FEV1_PCT_reversibility_postBD * 100, FEV1_PCT_reversibility_postBD))
 
summary(data_ORACLE$FEV1_PCT_reversibility_postBD) # Verify recoding
sum(is.na(data_ORACLE$FEV1_PCT_reversibility_postBD))
```

```{r, eval = FALSE}
# Convert Adherence in Trial to percentage format for specific trial
summary(data_ORACLE$Adherence_InTrial_quantity)
sum(is.na(data_ORACLE$Adherence_InTrial_quantity))

data_ORACLE <- data_ORACLE %>%
  mutate(Adherence_InTrial_quantity = 
           if_else(Enrolled_Trial_name %in% 
                     "CAPTAIN", Adherence_InTrial_quantity * 100, Adherence_InTrial_quantity))

summary(data_ORACLE$Adherence_InTrial_quantity) # Verify recoding
sum(is.na(data_ORACLE$Adherence_InTrial_quantity))
```

```{r, eval = FALSE}
# Create a new variable for Atopy history based on Eczema and/or Allergic Rhinitis status
data_ORACLE <- data_ORACLE %>%
  mutate(Atopy_history_0no_1yes_9999notknown_COMPUTED = 
           case_when(
             Eczema_0no_1yes_9999notknown == 1 ~ 1,
             AllergicRhinitis__0no_1yes_9999notknown == 1 ~ 1,
             Eczema_0no_1yes_9999notknown == 0 ~ 0,
             AllergicRhinitis__0no_1yes_9999notknown == 0 ~ 0), .after = AllergicRhinitis__0no_1yes_9999notknown)

```

```{r, eval = FALSE}
# The variable "Age" was received as both categorical and continuous depending on the trial 
# We recoded the original "Age" variable into categorical and continuous formats

# Create categorical variable
data_ORACLE <- data_ORACLE %>%
  mutate(Age_cat =
           case_when(Age == "[12,_33]" ~ "12 <= x <= 33",
                     Age == "[12,_42]" ~ "12 <= x <= 42",
                     Age == "[18,_38]" ~ "18 <= x <= 38",
                     Age == "[18,_41]" ~ "18 <= x <= 41",
                     Age == "]33,_47]" ~ "33 < x <= 47",
                     Age == "]38,_48]" ~ "38 < x <= 48",
                     Age == "]41,_50]" ~ "41 < x <= 50",
                     Age == "]42,_51]" ~ "42 < x <= 51",
                     Age == "]47,_58]" ~ "47 < x <= 58",
                     Age == "]48,_58]" ~ "48 < x <= 58",
                     Age == "]50,_58]" ~ "50 < x <= 58",
                     Age == "]51,_59]" ~ "51 < x <= 59",
                     Age == "]58,_80]" ~ "58 < x <= 80",
                     Age == "]58,_84]" ~ "58 < x <= 84",
                     Age == "]58,_87]" ~ "58 < x <= 87",
                     Age == "]59,_82]" ~ "59 < x <= 82",
                     Age == "0 < x <= 25" ~ Age,
                     Age == "10 < x <= 20" ~ Age,
                     Age == "10 < x <= 15" ~ Age,
                     Age == "15 < x <= 20" ~ Age,
                     Age == "20 < x <= 25" ~ Age,
                     Age == "20 < x <= 40" ~ Age,
                     Age == "25 < x <= 30" ~ Age,
                     Age == "25 < x <= 50" ~ Age,
                     Age == "30 < x <= 35" ~ Age,
                     Age == "35 < x <= 40" ~ Age,
                     Age == "40 < x <= 45" ~ Age,
                     Age == "45 < x <= 50" ~ Age,
                     Age == "50 < x <= 55" ~ Age,
                     Age == "50 < x <= 75" ~ Age,
                     Age == "55 < x <= 60" ~ Age,
                     Age == "60 < x <= 65" ~ Age,
                     Age == "60 < x <= 80" ~ Age,
                     Age == "65 < x <= 70" ~ Age,
                     Age == "70 < x <= 75" ~ Age,
                     Age == "20 < x <= 30" ~ Age,
                     Age == "30 < x <= 40" ~ Age,
                     Age == "40 < x <= 50" ~ Age,
                     Age == "50 < x <= 60" ~ Age,
                     Age == "60 < x <= 70" ~ Age,
                     Age == "70 < x <= 80" ~ Age,
                     Age == "6" ~ "0 < x <= 10",
                     Age == "7" ~ "0 < x <= 10",
                     Age == "8" ~ "0 < x <= 10",
                     Age == "9" ~ "0 < x <= 10",
                     Age == "10" ~ "0 < x <= 10",), .after = Age)

# Create continuous variable
data_ORACLE <- data_ORACLE %>%
  mutate(Age_con = ifelse(nchar(Age) <= 3, Age, NA), .after = Age_cat)

# Check for missing values in Age_con and convert to numeric
sum(is.na(data_ORACLE$Age_con))
data_ORACLE$Age_con = as.numeric(data_ORACLE$Age_con)
sum(is.na(data_ORACLE$Age_con))

# Replace missing values in Age_cat using Age_con
data_ORACLE <- data_ORACLE %>%
  mutate(Age_cat = case_when(
    is.na(Age_cat) & Age_con >= 0 & Age_con <= 10 ~ "0 < x <= 10",
    is.na(Age_cat) & Age_con > 10 & Age_con <= 15 ~ "10 < x <= 15",
    is.na(Age_cat) & Age_con > 15 & Age_con <= 20 ~ "15 < x <= 20",
    is.na(Age_cat) & Age_con > 20 & Age_con <= 25 ~ "20 < x <= 25",
    is.na(Age_cat) & Age_con > 25 & Age_con <= 30 ~ "25 < x <= 30",
    is.na(Age_cat) & Age_con > 30 & Age_con <= 35 ~ "30 < x <= 35",
    is.na(Age_cat) & Age_con > 35 & Age_con <= 40 ~ "35 < x <= 40",
    is.na(Age_cat) & Age_con > 40 & Age_con <= 45 ~ "40 < x <= 45",
    is.na(Age_cat) & Age_con > 45 & Age_con <= 50 ~ "45 < x <= 50",
    is.na(Age_cat) & Age_con > 50 & Age_con <= 55 ~ "50 < x <= 55",
    is.na(Age_cat) & Age_con > 55 & Age_con <= 60 ~ "55 < x <= 60",
    is.na(Age_cat) & Age_con > 60 & Age_con <= 65 ~ "60 < x <= 65",
    is.na(Age_cat) & Age_con > 65 & Age_con <= 70 ~ "65 < x <= 70",
    is.na(Age_cat) & Age_con > 70 & Age_con <= 75 ~ "70 < x <= 75",
    is.na(Age_cat) & Age_con > 75 & Age_con <= 80 ~ "75 < x <= 80",
    is.na(Age_cat) & Age_con > 80 & Age_con <= 85 ~ "80 < x <= 85",
    is.na(Age_cat) & Age_con > 85 & Age_con <= 90 ~ "85 < x <= 90",
    TRUE ~ as.character(Age_cat)
  ))

# Create Minimum variable for checks later
data_ORACLE <- data_ORACLE %>%
  mutate(Age_min =
           case_when(Age == "[12,_33]" ~ 12,
                     Age == "[12,_42]" ~ 12,
                     Age == "[18,_38]" ~ 18,
                     Age == "[18,_41]" ~ 18,
                     Age == "]33,_47]" ~ 33.1,
                     Age == "]38,_48]" ~ 38.1,
                     Age == "]41,_50]" ~ 41.1,
                     Age == "]42,_51]" ~ 42.1,
                     Age == "]47,_58]" ~ 47.1,
                     Age == "]48,_58]" ~ 48.1,
                     Age == "]50,_58]" ~ 50.1,
                     Age == "]51,_59]" ~ 51.1,
                     Age == "]58,_80]" ~ 58.1,
                     Age == "]58,_84]" ~ 58.1,
                     Age == "]58,_87]" ~ 58.1,
                     Age == "]59,_82]" ~ 59.1,
                     Age_cat == "0 < x <= 25" ~ 12,
                     Age_cat == "0 < x <= 10" ~ 0,
                     Age_cat == "10 < x <= 20" ~ 12,
                     Age_cat == "10 < x <= 15" ~ 12,
                     Age_cat == "15 < x <= 20" ~ 15.1,
                     Age_cat == "20 < x <= 25" ~ 20.1,
                     Age_cat == "20 < x <= 40" ~ 20.1,
                     Age_cat == "25 < x <= 30" ~ 25.1,
                     Age_cat == "25 < x <= 50" ~ 25.1,
                     Age_cat == "30 < x <= 35" ~ 30.1,
                     Age_cat == "35 < x <= 40" ~ 35.1,
                     Age_cat == "40 < x <= 45" ~ 40.1,
                     Age_cat == "45 < x <= 50" ~ 45.1,
                     Age_cat == "50 < x <= 55" ~ 50.1,
                     Age_cat == "50 < x <= 75" ~ 50.1,
                     Age_cat == "55 < x <= 60" ~ 55.1,
                     Age_cat == "60 < x <= 65" ~ 60.1,
                     Age_cat == "60 < x <= 80" ~ 60.1,
                     Age_cat == "65 < x <= 70" ~ 65.1,
                     Age_cat == "70 < x <= 75" ~ 70.1,
                     Age_cat == "20 < x <= 30" ~ 20.1,
                     Age_cat == "30 < x <= 40" ~ 30.1,
                     Age_cat == "40 < x <= 50" ~ 40.1,
                     Age_cat == "50 < x <= 60" ~ 50.1,
                     Age_cat == "60 < x <= 70" ~ 60.1,
                     Age_cat == "70 < x <= 80" ~ 70.1,
                     Age_cat == "75 < x <= 80" ~ 75.1,
                     Age_cat == "80 < x <= 85" ~ 80.1,
                     Age_cat == "85 < x <= 90" ~ 85.1,), .after = Age_con)

# Create Maximum variable for checks later
data_ORACLE <- data_ORACLE %>%
  mutate(Age_max =
           case_when(Age == "[12,_33]" ~ 33,
                     Age == "[12,_42]" ~ 42,
                     Age == "[18,_38]" ~ 38,
                     Age == "[18,_41]" ~ 41,
                     Age == "]33,_47]" ~ 47,
                     Age == "]38,_48]" ~ 48,
                     Age == "]41,_50]" ~ 50,
                     Age == "]42,_51]" ~ 51,
                     Age == "]47,_58]" ~ 58,
                     Age == "]48,_58]" ~ 58,
                     Age == "]50,_58]" ~ 58,
                     Age == "]51,_59]" ~ 59,
                     Age == "]58,_80]" ~ 80,
                     Age == "]58,_84]" ~ 84,
                     Age == "]58,_87]" ~ 87,
                     Age == "]59,_82]" ~ 82,
                     Age_cat == "0 < x <= 25" ~ 25,
                     Age_cat == "0 < x <= 10" ~ 10,
                     Age_cat == "10 < x <= 20" ~ 20,
                     Age_cat == "10 < x <= 15" ~ 15,
                     Age_cat == "15 < x <= 20" ~ 20,
                     Age_cat == "20 < x <= 25" ~ 25,
                     Age_cat == "20 < x <= 40" ~ 40,
                     Age_cat == "25 < x <= 30" ~ 30,
                     Age_cat == "25 < x <= 50" ~ 50,
                     Age_cat == "30 < x <= 35" ~ 35,
                     Age_cat == "35 < x <= 40" ~ 40,
                     Age_cat == "40 < x <= 45" ~ 45,
                     Age_cat == "45 < x <= 50" ~ 50,
                     Age_cat == "50 < x <= 55" ~ 55,
                     Age_cat == "50 < x <= 75" ~ 75,
                     Age_cat == "55 < x <= 60" ~ 60,
                     Age_cat == "60 < x <= 65" ~ 65,
                     Age_cat == "60 < x <= 80" ~ 80,
                     Age_cat == "65 < x <= 70" ~ 70,
                     Age_cat == "70 < x <= 75" ~ 75,
                     Age_cat == "20 < x <= 30" ~ 30,
                     Age_cat == "30 < x <= 40" ~ 40,
                     Age_cat == "40 < x <= 50" ~ 50,
                     Age_cat == "50 < x <= 60" ~ 60,
                     Age_cat == "60 < x <= 70" ~ 70,
                     Age_cat == "70 < x <= 80" ~ 71,
                     Age_cat == "75 < x <= 80" ~ 80,
                     Age_cat == "80 < x <= 85" ~ 85,
                     Age_cat == "85 < x <= 90" ~ 90,), .after = Age_min)
```

```{r, eval = FALSE}
# The variable "BMI" was received as both categorical and continuous depending on the trial 
# We recoded the original "BMI" variable into categorical and continuous formats

# Create categorical variable
data_ORACLE <- data_ORACLE %>%
  mutate(BMI_cat =
           case_when(BMI == "0 < x <= 19" ~ BMI,
                     BMI == "19 < x <= 25" ~ BMI,
                     BMI == "25 < x <= 30" ~ BMI,
                     BMI == "30 < x <= 80" ~ BMI,
                     BMI == "Normal_weight" ~ "19 < x <= 25",
                     BMI == "Obesity" ~ "30 < x <= 80",
                     BMI == "Obesity_class_I" ~ "30 < x <= 35",
                     BMI == "Obesity_class_II" ~ "35 < x <= 40",
                     BMI == "Obesity_class_III" ~ "40 < x",
                     BMI == "Overweight" ~ "25 < x <= 30",
                     BMI == "Pre-obesity" ~ "25 < x <= 30",
                     BMI == "Underweight" ~ "0 < x <= 19"), .after = BMI)

# Create continuous variable
data_ORACLE <- data_ORACLE %>%
  mutate(BMI_con = ifelse(!grepl("x", BMI) & 
                            !grepl("obesity", BMI,  ignore.case = TRUE) & 
                            !grepl("weight", BMI,  ignore.case = TRUE), BMI, NA), .after = BMI_cat)

# Check for missing values in BMI_con and convert to numeric
sum(is.na(data_ORACLE$BMI_con)) 
data_ORACLE$BMI_con = as.numeric(data_ORACLE$BMI_con)
sum(is.na(data_ORACLE$BMI_con))

# Replace missing values in BMI_cat using BMI_con
data_ORACLE <- data_ORACLE %>%
  mutate(BMI_cat = case_when(
    is.na(BMI_cat) & BMI_con <= 19 ~ "0 < x <= 19",
    is.na(BMI_cat) & BMI_con > 19 & BMI_con <= 25 ~ "19 < x <= 25",
    is.na(BMI_cat) & BMI_con > 25 & BMI_con <= 30 ~ "25 < x <= 30",
    is.na(BMI_cat) & BMI_con > 30 & BMI_con <= 35 ~ "30 < x <= 35",
    is.na(BMI_cat) & BMI_con > 35 & BMI_con <= 40 ~ "35 < x <= 40",
    is.na(BMI_cat) & BMI_con > 40  ~ "40 < x",
    TRUE ~ as.character(BMI_cat)
  ))

# Create Minimum variable for checks later
data_ORACLE <- data_ORACLE %>%
  mutate(BMI_min =
           case_when(BMI_cat == "0 < x <= 19" ~ 0.001,
                     BMI_cat == "19 < x <= 25" ~ 19.001,
                     BMI_cat == "25 < x <= 30" ~ 25.001,
                     BMI_cat == "30 < x <= 80" ~ 30.001,
                     BMI_cat == "30 < x <= 35" ~ 30.001,
                     BMI_cat == "35 < x <= 40" ~ 35.001,
                     BMI_cat == "40 < x" ~ 40.001,
                     BMI == "Normal_weight" ~ 19.001,
                     BMI == "Obesity" ~ 30.001,
                     BMI == "Obesity_class_I" ~ 30.001,
                     BMI == "Obesity_class_II" ~ 35.001,
                     BMI == "Obesity_class_III" ~ 40.001,
                     BMI == "Overweight" ~ 25.001,
                     BMI == "Pre-obesity" ~ 25.001,
                     BMI == "Underweight" ~ 0.001), .after = BMI_con)

# Create Maximum variable for checks later
data_ORACLE <- data_ORACLE %>%
  mutate(BMI_max =
           case_when(BMI_cat == "0 < x <= 19" ~ 19,
                     BMI_cat == "19 < x <= 25" ~ 25,
                     BMI_cat == "25 < x <= 30" ~ 30,
                     BMI_cat == "30 < x <= 80" ~ 80,
                     BMI_cat == "30 < x <= 35" ~ 35,
                     BMI_cat == "35 < x <= 40" ~ 40,
                     BMI_cat == "40 < x" ~ 80,
                     BMI == "Normal_weight" ~ 24.9,
                     BMI == "Obesity" ~ 80,
                     BMI == "Obesity_class_I" ~ 34.9,
                     BMI == "Obesity_class_II" ~ 39.9,
                     BMI == "Obesity_class_III" ~ 80,
                     BMI == "Overweight" ~ 30,
                     BMI == "Pre-obesity" ~ 29.9,
                     BMI == "Underweight" ~ 18.5), .after = BMI_min)

```

```{r, eval = FALSE}
# The variable "History of severe asthma attacks" was recoded into a continuous variable 
# Remaining missing values were replaced using multiple imputation

data_ORACLE <- data_ORACLE %>%
  mutate(Number_severe_attack_previous_12m_con = 
           ifelse(!grepl(">", Number_severe_attack_previous_12m) & 
                    !grepl("1-2", Number_severe_attack_previous_12m,  ignore.case = TRUE), Number_severe_attack_previous_12m, NA), 
         .after = Number_severe_attack_previous_12m)

data_ORACLE$Number_severe_attack_previous_12m_con = as.numeric(data_ORACLE$Number_severe_attack_previous_12m_con)
```

```{r, eval = FALSE}
# The variable "History of hospitalisations" was recoded into a continuous variable 
# Remaining missing values were replaced using multiple imputation

data_ORACLE <- data_ORACLE %>%
  mutate(Number_hospitalisations_for_asthma_previous_12_months_con = 
           ifelse(Number_hospitalisations_for_asthma_previous_12_months >= 0, Number_hospitalisations_for_asthma_previous_12_months, NA), 
         .after = Number_hospitalisations_for_asthma_previous_12_months)

data_ORACLE$Number_hospitalisations_for_asthma_previous_12_months_con = as.numeric(data_ORACLE$Number_hospitalisations_for_asthma_previous_12_months_con)
```

```{r, eval = FALSE}
# For non-smokers, the value of variable "Pack years" was sometimes missing, although we know from logically thinking that this should be 0
# Recode Pack years: set to 0 for non-smokers
data_ORACLE <- data_ORACLE %>%
  mutate(Pack_years = case_when(
    Smoking_0never_1ex_2current == 0 ~ "0",
    !is.na(Pack_years) ~ Pack_years
  ))
```

```{r, eval = FALSE}
# The variable "Pack years" was received as both categorical and continuous depending on the trial 
# We recoded the original "Pack years" variable into categorical and continuous formats

# Create continuous variable
data_ORACLE <- data_ORACLE %>%
  mutate(Pack_years_con = ifelse(!grepl("per", Pack_years, ignore.case = TRUE), Pack_years, NA), .after = Pack_years)

# Check for missing values in Pack_years_con and convert to numeric
sum(is.na(data_ORACLE$Pack_years_con)) 
data_ORACLE$Pack_years_con = as.numeric(data_ORACLE$Pack_years_con)
sum(is.na(data_ORACLE$Pack_years_con))  # same number is good; changing the data type should not create missing values

# Create categorical variable
data_ORACLE <- data_ORACLE %>%
  mutate(Pack_years_cat =
           case_when(Pack_years == "<10 cigarettes per day" ~ Pack_years,
                     Pack_years == ">=10 cigarettes per day" ~ Pack_years,
                     Pack_years_con == 0 ~ "0 cigarettes per day",
                     Pack_years_con < 10 ~ "<10 cigarettes per day",
                     Pack_years_con >= 10 ~ ">=10 cigarettes per day"), .after = Pack_years_con)

# Create Minimum variable for checks later
data_ORACLE <- data_ORACLE %>%
  mutate(Pack_years_min =
           case_when(Pack_years_cat == "<10 cigarettes per day" ~ 0.001,
                     Pack_years_cat == ">=10 cigarettes per day" ~ 10,
                     Pack_years_cat == "0 cigarettes per day" ~ 0), .after = Pack_years_cat)

# Create Maximum variable for checks later
data_ORACLE <- data_ORACLE %>%
  mutate(Pack_years_max =
           case_when(Pack_years_cat == "<10 cigarettes per day" ~ 9.9,
                     Pack_years_cat == ">=10 cigarettes per day" ~ 20, # 20 pack years was the maximum value in the dataset
                     Pack_years_cat == "0 cigarettes per day" ~ 0), .after = Pack_years_min)

```

```{r, eval = FALSE}
# Variable "Country" was regrouped into regions due to the high number of country levels

sum(is.na(data_ORACLE$Country)) # Check number of missing values

data_ORACLE$Country <- as.factor(data_ORACLE$Country)
unique(data_ORACLE$Country) # List unique countries in the dataset

data_ORACLE <- data_ORACLE %>%
  mutate(Region = case_when(
    Country == "Italy" ~ "Europe",
    Country == "United_Kingdom" ~ "Europe",
    Country == "United Kingdom" ~ "Europe",
    Country == "UK - CMD" ~ "Europe",
    Country == "Belgium" ~ "Europe",
    Country == "Europe"  ~ "Europe",
    Country == "Poland" ~ "Europe",
    Country == "Romania" ~ "Europe",
    Country == "Hungria" ~ "Europe",
    Country == "Hungary" ~ "Europe",
    Country == "Czech_Republic" ~ "Europe",
    Country == "Belarus" ~ "Europe",
    Country == "Ukraine" ~ "Europe",
    Country == "Spain" ~ "Europe",
    Country == "Slovakia" ~ "Europe",
    Country == "Russia" ~ "Europe",
    Country == "Russian Federation" ~ "Europe",
    Country == "France" ~ "Europe",
    Country == "Serbia" ~ "Europe",
    Country == "Bulgaria" ~ "Europe",
    Country == "Germany" ~ "Europe",
    Country == "Netherlands" ~ "Europe",
    Country == "Latvia" ~ "Europe",
    Country == "Lithuania" ~ "Europe",
    Country == "Asia" ~ "Asia",
    Country == "Japan" ~ "Asia",
    Country == "Korea" ~ "Asia",
    Country == "Korea, Republic of" ~ "Asia",
    Country == "Israel" ~ "Asia",
    Country == "Turkey" ~ "Asia",
    Country == "Vietnam" ~ "Asia",
    Country == "South_Korea" ~ "Asia",
    Country == "North_America" ~ "North_America",
    Country == "United_States" ~ "North_America",
    Country == "United States" ~ "North_America",
    Country == "Canada" ~ "North_America",
    Country == "Mexico" ~ "North_America",
    Country == "South_America" ~ "South_America",
    Country == "Argentina" ~ "South_America",
    Country == "Chile" ~ "South_America",
    Country == "Peru" ~ "South_America",
    Country == "Brazil" ~ "South_America",
    Country == "Australia" ~ "Oceania",
    Country == "New_Zealand" ~ "Oceania",
    Country == "Oceania" ~ "Oceania",
    Country == "South_Africa" ~ "South_Africa",
    Country == "South Africa" ~ "South_Africa"), .after = Country)

data_ORACLE$Region <- as.factor(data_ORACLE$Region)
```

```{r, eval = FALSE}
# Variable "Ethnicity" was provided with different spelling (capitals/lower case)

unique(data_ORACLE$Ethnicity) # Check unique values in Ethnicity column

# Standardize the spelling of Ethnicity values
data_ORACLE <- data_ORACLE %>%
  mutate(Ethnicity = case_when(
    Ethnicity == "American_Indian_or_Alaska_Native" ~ Ethnicity,
    Ethnicity == "Asian" ~ Ethnicity,
    Ethnicity == "ASIAN" ~ "Asian",
    Ethnicity == "BLACK OR AFRICAN AMERICAN" ~ "Black_or_African_American",
    Ethnicity == "Black_or_African_American" ~ Ethnicity,
    Ethnicity == "Maori" ~ Ethnicity,
    Ethnicity == "Multiple" ~ Ethnicity,
    Ethnicity == "Native_Hawaiian_or_other_Pacific_Islander" ~ Ethnicity,
    Ethnicity == "Other" ~ Ethnicity,
    Ethnicity == "OTHER" ~ "Other",
    Ethnicity == "White" ~ Ethnicity,
    Ethnicity == "WHITE" ~ "White"
  ))

# Check unique values again to ensure standardization
unique(data_ORACLE$Ethnicity)
```

```{r, eval = FALSE}
# Compute a new variable for previous ICU or intubation
data_ORACLE <- data_ORACLE %>%
  mutate(Previous_ICU_or_intubation_0no_1yes = 
           case_when(Previous_ICU_0no_1yes_9999notknown == 1 ~ 1,
                     Previous_Intubation_0no_1yes_9999notknown == 1 ~ 1,
                     Previous_ICU_0no_1yes_9999notknown == 0 ~ 0,
                     Previous_Intubation_0no_1yes_9999notknown == 0 ~ 0), .after = Previous_Intubation_0no_1yes_9999notknown)

```

# Inclusion criteria

```{r, eval = FALSE}
# We received not only the placebo and control arms, but also the treatment arms from some studies
# Filter the data to include only the placebo arms for the analyses

data_arm <- data_ORACLE %>% 
  subset(Treatment_arm %in% 
           c("FF/UMEC/VI 100/31.25/25",
             "FF/UMEC/VI 100/62.5/25", 
             "FF/VI 100/25", 
             "Placebo", 
             "Montelukast", 
             "PLACEBO", 
             "PBO", 
             "Salbutamol_PRN", 
             "BUD400_Terbutaline_PRN", 
             "Placebo_1.14mL", 
             "Placebo_2mL"))

nrow(filter(data_arm)) # Interim number of participants in dataset
```

```{r, eval = FALSE}
# One of the inclusion criteria was: no missing values in treatment arm
# Check for missing values in Treatment_arm and remove them

sum(is.na(data_arm$Treatment_arm))
data_arm <- data_arm %>% drop_na(Treatment_arm)
nrow(filter(data_arm)) # Interim number of participants after removing missing values
```

```{r, eval = FALSE}
# One of the inclusion criteria was: aged 12 or over
# Include only participants of 12 years and older

sum(data_arm$Age_con <= 11, na.rm= TRUE) # Number of participants 11 years old or younger
data_arm_age12 <- data_arm[is.na(data_arm$Age_con) | data_arm$Age_con > 11,]
min(data_arm_age12$Age_con, na.rm= TRUE) # Check if 12 years is now the minimum age
nrow(filter(data_arm_age12)) # Interim number of participants aged 12 or older
```

```{r, eval = FALSE}
# One of the inclusion criteria was: no missing values in follow-up duration
# Include only participants with a follow-up of >= 1 day

sum(is.na(data_arm_age12$Follow_up_duration_days)) # Missing values in Follow up duration
sum(data_arm_age12$Follow_up_duration_days == 0, na.rm=TRUE) # Participants with follow-up duration of 0 days
data_arm_age12 <- subset(data_arm_age12, !is.na(Follow_up_duration_days) & Follow_up_duration_days != 0)
nrow(filter(data_arm_age12)) # Interim number of participants with follow-up >= 1 day
```

```{r, eval = FALSE}
# One of the inclusion criteria was: no missing values in treatment step
# Include only participants with non-missing treatment step

sum(is.na(data_arm_age12$Treatment_step)) # Missing values in Treatment step
data_arm_age12 <- subset(data_arm_age12, !is.na(Treatment_step))
nrow(filter(data_arm_age12)) # Total number of participants in final dataset
```

```{r, eval = FALSE}
write.csv(data_arm_age12, "Network:/dataset.csv", row.names=FALSE) # Save the dataset to your network location for later use
```

```{r, eval = FALSE}
data_arm_age12 <- read.csv("Network:/dataset.csv") # Read the dataset from the network location
```


# Flowchart

```{r, eval = FALSE}
# Extended version of the flowchart

# Load the grid package for creating graphical objects
grid.newpage()

# Define graphical boxes for each step in the flowchart
# The numbers were calculated in "#Inclusion criteria"
flowchart_1 <- boxGrob("Total number of patients\nn=6620",
                         x=0.4, y=0.90)
flowchart_2 <- boxGrob("Age >= 12 years old\nn=6539",
                       x=0.4, y=0.70)
flowchart_3 <- boxGrob("Excluded (n=81):\n Age < 12 (n=81)",
                       x=0.6, y=0.80)
flowchart_4 <- boxGrob("Follow-up duration > 0\nn=6519",
                       x=0.4, y=0.50)
flowchart_5 <- boxGrob("Excluded (n=20):\n Follow-up duration = 0 (n=20)",
                       x=0.6, y=0.60)
flowchart_6 <- boxGrob("Treatment step non-missing\nn=6516",
                       x=0.4, y=0.30)
flowchart_7 <- boxGrob("Excluded (n=3):\n Treatment step = NA (n=3)",
                       x=0.6, y=0.40)

# Connect the graphical boxes with arrows
connectGrob(flowchart_1, flowchart_2, "vertical")  # Connect step 1 to step 2
connectGrob(flowchart_1, flowchart_3, "-")         # Connect step 1 to exclusion 1
connectGrob(flowchart_2, flowchart_4, "vertical")  # Connect step 2 to step 4
connectGrob(flowchart_2, flowchart_5, "-")         # Connect step 2 to exclusion 2
connectGrob(flowchart_4, flowchart_6, "vertical")  # Connect step 4 to step 6
connectGrob(flowchart_4, flowchart_7, "-")         # Connect step 4 to exclusion 3

# Display the graphical boxes
flowchart_1
flowchart_2
flowchart_3
flowchart_4
flowchart_5
flowchart_6
flowchart_7
```

```{r, eval = FALSE}
# Short version of the flowchart

# Load the grid package for creating graphical objects
grid.newpage()

# Define graphical boxes for each step in the flowchart
# The numbers were calculated in "#Inclusion criteria"
flowchart_8 <- boxGrob("Total number of patients\nn=6539",
                       x=0.4, y=0.90)
flowchart_9 <- boxGrob("Follow-up duration > 0\nn=6519",
                       x=0.4, y=0.70)
flowchart_10 <- boxGrob("Excluded (n=20):\n Follow-up duration = 0 (n=20)",
                       x=0.7, y=0.80)
flowchart_11 <- boxGrob("Treatment step non-missing\nn=6516",
                       x=0.4, y=0.50)
flowchart_12 <- boxGrob("Excluded (n=3):\n Treatment step = NA (n=3)",
                       x=0.7, y=0.60)

# Connect the graphical boxes with arrows
connectGrob(flowchart_8, flowchart_9, "vertical")  # Connect step 8 to step 9
connectGrob(flowchart_8, flowchart_10, "-")        # Connect step 8 to exclusion 10
connectGrob(flowchart_9, flowchart_11, "vertical") # Connect step 9 to step 11
connectGrob(flowchart_9, flowchart_12, "-")        # Connect step 9 to exclusion 12

# Display the graphical boxes
flowchart_8
flowchart_9
flowchart_10
flowchart_11
flowchart_12
```


# Figure S1-S4: Missing value patterns

```{r, eval = FALSE}
# Figure S1

# Save the plot as a PNG file with specified dimensions
png("na_patterns_plot.png", width = 1200, height = 800)

# Calculate the patterns of missing values in the data
na.patterns <- naclus(data) 

# Plot the patterns of missing values with specific y-axis label and color
plot(na.patterns, ylab="Fraction of missing values in common", col='red')

dev.off() # close the PNG
```

```{r, eval = FALSE}
# Figure S2

# Save the plots as a PNG file with specified dimensions
png("Common_naplots.png", width = 1200, height = 1400)

# Set up a 2x2 layout for the plots
layout(matrix(1:4, nrow = 2, ncol = 2))

naplot(na.patterns, col="red", cex=1.1, cex.main=0.9) # render the first plot
naplot(na.patterns, col="red", cex=1.1, cex.main=0.9) # render the second plot

dev.off() # close the PNG
```

```{r, eval = FALSE}
# Figure S3

# Select a subset of columns from the data for main analysis
data_main <- data[,c(7,8,37,42:44,46,47)]

# Calculate the patterns of missing values for the selected subset of data
na.patterns2 <- naclus(data_main)

# Save the plots as a PNG file with specified dimensions
png("Common_naplots_main.png", width = 800, height = 800)

# Set up a 2x2 layout for the plots
layout(matrix(1:4, nrow = 2, ncol = 2))

naplot(na.patterns2, col="red", cex=1.1, cex.main=0.9) # render the first plot
naplot(na.patterns2, col="red", cex=1.1, cex.main=0.9) # render the second plot

dev.off() # close the PNG

```

```{r, eval = FALSE}
# Figure S4

# Save the plot as a PNG file with specified dimensions
png("intersections_missing_main.png", width = 700, height = 500)

# Create an upset plot to visualize the intersections of missing values in the subset of data
naniar::gg_miss_upset(data = data_main)
dev.off() # close the PNG

```


# Table 2: Baseline characteristics

```{r, eval = FALSE}
# Label variables for a clear Table 2 output
# Add units for certain variables

label(data_arm_age12$Age) <- "Age"

data_arm_age12$Gender_0Female_1Male <- factor(data_arm_age12$Gender_0Female_1Male, levels=c(0,1), labels=c("Female", "Male"))
label(data_arm_age12$Gender_0Female_1Male) <- "Sex, n(%)"

label(data_arm_age12$Treatment_step) <- "Treatment step, n(%)"

data_arm_age12$Ethnicity <- factor(data_arm_age12$Ethnicity,
                                 levels=c("American_Indian_or_Alaska_Native",
                                          "Asian",
                                          "Black_or_African_American",
                                          "Maori",
                                          "Multiple",
                                          "Native_Hawaiian_or_other_Pacific_Islander",
                                          "Other",
                                          "White"))
data_arm_age12$Ethnicity <- factor(data_arm_age12$Ethnicity, 
                                   levels=c("American_Indian_or_Alaska_Native",
                                            "Asian",
                                            "Black_or_African_American",
                                            "Maori",
                                            "Multiple",
                                            "Native_Hawaiian_or_other_Pacific_Islander",
                                            "Other",
                                            "White"))
label(data_arm_age12$Ethnicity) <- "Ethnicity, n(%)"

data_arm_age12$Region <- factor(data_arm_age12$Region,
                                levels=c("Asia",
                                         "Europe",
                                         "North_America",
                                         "Oceania",
                                         "South_Africa",
                                         "South_America"))
data_arm_age12$Region <- factor(data_arm_age12$Region,
                                levels=c("Asia",
                                         "Europe",
                                         "North_America",
                                         "Oceania",
                                         "South_Africa",
                                         "South_America"), labels=c("Asia","Europe","North_America","Oceania","South_Africa","South_America"))
label(data_arm_age12$Region) <- "Region, n(%)"

label(data_arm_age12$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced) <- "Blood eosinophils"
units(data_arm_age12$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced) <- "x10^9 cells/L"

label(data_arm_age12$FeNO_baseline_ppb) <- "FeNO"
units(data_arm_age12$FeNO_baseline_ppb) <- "ppb"

label(data_arm_age12$Total_IgE) <- "Total IgE"
units(data_arm_age12$Total_IgE) <- "ng/mL"

label(data_arm_age12$BMI) <- "Body Mass Index"
units(data_arm_age12$BMI) <- "kg/m2"

label(data_arm_age12$FEV1_preBD_PCT_Baseline) <- "FEV1"
units(data_arm_age12$FEV1_preBD_PCT_Baseline) <- "% of predicted"

label(data_arm_age12$FEV1_FVC_ratio) <- "FEV1/FVC"

data_arm_age12$Previous_ICU_or_intubation_0no_1yes <- factor(data_arm_age12$Previous_ICU_or_intubation_0no_1yes, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Previous_ICU_or_intubation_0no_1yes) <- "Previous ICU or intubation, n(%)"

data_arm_age12$Previous_ICU_0no_1yes_9999notknown <- factor(data_arm_age12$Previous_ICU_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Previous_ICU_0no_1yes_9999notknown) <- "Previous ICU, n(%)"

data_arm_age12$Previous_Intubation_0no_1yes_9999notknown <- factor(data_arm_age12$Previous_Intubation_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Previous_Intubation_0no_1yes_9999notknown) <- "Previous intubation, n(%)"

data_arm_age12$Atopy_history_0no_1yes_9999notknown <- factor(data_arm_age12$Atopy_history_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Atopy_history_0no_1yes_9999notknown) <- "Atopy history, n(%)"

data_arm_age12$Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown <- factor(data_arm_age12$Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown) <- "Allergy testing positive, n(%)"

data_arm_age12$Eczema_0no_1yes_9999notknown <- factor(data_arm_age12$Eczema_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Eczema_0no_1yes_9999notknown) <- "Eczema, n(%)"

data_arm_age12$AllergicRhinitis__0no_1yes_9999notknown <- factor(data_arm_age12$AllergicRhinitis__0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$AllergicRhinitis__0no_1yes_9999notknown) <- "Allergic rhinitis, n(%)"

data_arm_age12$Chronic_Rhinosinusitis_0no_1yes_9999notknown <- factor(data_arm_age12$Chronic_Rhinosinusitis_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Chronic_Rhinosinusitis_0no_1yes_9999notknown) <- "Chronic rhinosinusitis, n(%)"

data_arm_age12$Nasal_polyposis_0no_1yes_9999notknown <- factor(data_arm_age12$Nasal_polyposis_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Nasal_polyposis_0no_1yes_9999notknown) <- "Nasal polyposis, n(%)"

data_arm_age12$Previous_nasal_polypectomy_0no_1yes_9999notknown <- factor(data_arm_age12$Previous_nasal_polypectomy_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Previous_nasal_polypectomy_0no_1yes_9999notknown) <- "Previous nasal polypectomy, n(%)"

label(data_arm_age12$ACQ_baseline_score_mean) <- "ACQ-5"

data_arm_age12$Psychiatric_disease_0no_1yes_9999notknown <- factor(data_arm_age12$Psychiatric_disease_0no_1yes_9999notknown, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Psychiatric_disease_0no_1yes_9999notknown) <- "Psychiatric disease, n(%)"

data_arm_age12$Smoking_0never_1ex_2current <- factor(data_arm_age12$Smoking_0never_1ex_2current, levels=c(0,1,2), labels=c("Never smoked","Ex-smoker", "Current smoker"))
label(data_arm_age12$Smoking_0never_1ex_2current) <- "Smoking history, n(%)"

label(data_arm_age12$Psy_disease_type_0none_1depressionORanxiety_2psychosis_3nontobaccosubstanceabuse_4other_9999notknown) <- "Psychiatric disease, n(%)"

data_arm_age12$Any_ICS_prescribed_0no_1yes <- factor(data_arm_age12$Any_ICS_prescribed_0no_1yes, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$Any_ICS_prescribed_0no_1yes) <- "On ICS, n(%)"

data_arm_age12$ICS_DOSE_CLASS <- factor(data_arm_age12$ICS_DOSE_CLASS, levels=c("0","Low","Medium","High"))
label(data_arm_age12$ICS_DOSE_CLASS) <- "ICS Dose, n(%)"

data_arm_age12$SABA_prescribed__0no_1yes <- factor(data_arm_age12$SABA_prescribed__0no_1yes, levels=c(1,0), labels=c("Yes", "No"))
label(data_arm_age12$SABA_prescribed__0no_1yes) <- "On SABA, n(%)"

label(data_arm_age12$SABA_actuations_per_day_average_PreTrial) <- "SABA actuations per day pre trial"
label(data_arm_age12$SABA_actuations_per_day_average_InTrial) <- "SABA actuations

```

```{r, eval = FALSE}
# Identify observations for Age and BMI with categorical values
# Assign levels to the newly created variables indicating the format (continuous or in categories)

data_arm_age12 <- data_arm_age12 %>% 
  mutate(Age_format = case_when(
    Age_cat == "NA" ~ NA,
    !is.na(Age) ~ "Continuous",
    TRUE ~ "In categories"))
data_arm_age12$Age_format <- factor(data_arm_age12$Age_format, levels=c("Continuous","In categories"))

data_arm_age12 <- data_arm_age12 %>% 
  mutate(BMI_format = case_when(
    BMI_cat == "NA" ~ NA,
    !is.na(BMI) ~ "Continuous",
    TRUE ~ "In categories"))
data_arm_age12$BMI_format <- factor(data_arm_age12$BMI_format, levels=c("Continuous","In categories"))
```

```{r, eval = FALSE}
# Create groups of cut-off values for variables that are additionally  shown in groups in Table 2
# Label the different groups per variable

data_arm_age12$FEV1_PCT_reversibility_postBD_by_group <- 
  cut(data_arm_age12$FEV1_reversibility_percent_postBD_real, 
      breaks = c(-1000,12,1000), 
      labels=c("<12%","⩾12%"))

label(data_arm_age12$FEV1_PCT_reversibility_postBD_by_group) <- "FEV1 reversibility (by group)"

data_arm_age12$ACQ_baseline_score_mean_by_group <- 
  cut(data_arm_age12$ACQ_baseline_score_mean, 
      breaks = c(-1000,1.5,1000), 
      labels=c("<1.5","⩾1.5%"))

label(data_arm_age12$ACQ_baseline_score_mean_by_group) <- "ACQ-5 (by group)"

data_arm_age12$Exacerbations_during_follow_up_by_group <- 
  cut(data_arm_age12$Number_severe_asthma_attacks_during_followup, 
      breaks = c(-1000,0.9,1000), 
      labels=c("0","⩾1"))

label(data_arm_age12$Exacerbations_during_follow_up_by_group) <- "In trial severe exacerbations, n(%)"
```

```{r, eval = FALSE}
# Code function for continuous and categorical variables output in Table 2
# Continuous: Mean (SD), Median (IQR), Geometric mean (GSD), Range/Minimum/Maximum
# Categorical: Percentage

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x, ), digits = 3), 
       c("", "Mean (SD)"= sprintf("%s (&plusmn; %s)", MEAN, SD), 
         "Median (IQR)"= sprintf(paste("%s (%s - %s)"), MEDIAN, Q1, Q3),
         "Geo. mean (GSD)"= sprintf("%s (&plusmn; %s)", GMEAN, GSD),
         "Geo. mean (IQR)"= sprintf(paste("%s (%s - %s)"), GMEAN, Q1, Q3), 
         "Range"=sprintf("%s - %s", MIN, MAX)))}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x), function(y) with(y, sprintf("%d (%0.0f%%)", FREQ, PCT))))}
```

```{r, eval = FALSE}
# Table 2 disentangled by trial

Table2_by_trial <- 
  table1(~ Age + # Add all variables for Table 2
           Age_format + 
           Gender_0Female_1Male + 
           Ethnicity + 
           Region + 
           Treatment_step +
           Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced +
           FeNO_baseline_ppb + 
           Total_IgE + 
           BMI + 
           BMI_format +
           FEV1_preBD_PCT_Baseline + 
           FEV1_FVC_ratio + 
           FEV1_reversibility_percent_postBD_real + 
           FEV1_PCT_reversibility_postBD_by_group + 
           Previous_ICU_or_intubation_0no_1yes + 
           Previous_ICU_0no_1yes_9999notknown + 
           Previous_Intubation_0no_1yes_9999notknown + 
           Atopy_history_0no_1yes_9999notknown +
           Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown + 
           Eczema_0no_1yes_9999notknown +
           AllergicRhinitis__0no_1yes_9999notknown + 
           Chronic_Rhinosinusitis_0no_1yes_9999notknown + 
           Nasal_polyposis_0no_1yes_9999notknown + 
           Previous_nasal_polypectomy_0no_1yes_9999notknown + 
           ACQ_baseline_score_mean + 
           ACQ_baseline_score_mean_by_group + 
           Smoking_0never_1ex_2current + 
           Psychiatric_disease_0no_1yes_9999notknown + 
           Any_ICS_prescribed_0no_1yes + 
           ICS_DOSE_CLASS + 
           SABA_prescribed__0no_1yes + 
           SABA_actuations_per_day_average_PreTrial + 
           SABA_actuations_per_day_average_InTrial + 
           maintenance_OCS_prescribed__0no_1yes + 
           Intranasal_seroid_prescribed__0no_1yes + 
           LABA_prescribed_0no_1yes + 
           LAMA_prescribed__0no_1yes + 
           Montelukast_prescribed__0no_1yes + 
           Adherence_PreTrial_quantity + 
           Adherence_InTrial_quantity_real + 
           Any_attack_or_hospitalization_previous_12_months + 
           Follow_up_duration_days_nozero + 
           Exacerbations_during_follow_up_by_group 
                  | Enrolled_Trial_name, # Add "|" to disentangle the data by a certain variable, here by enrolled trial
                       overall = c(left="Total"), # Add "overall=" for a column with the total study population
                       data = data_arm_age12,
                       render.continuous = my.render.cont, # Add the functions for continuous and categorical variable output
                       render.categorical = my.render.cat)

# Print the table
print(Table2_by_trial)
```   

```{r, eval = FALSE}
# Other information for required Table 2

## Total follow-up and number of severe asthma attacks
table_total <- data.frame(c(sum(data_arm_age12$Follow_up_duration_years_nozero, na.rm=TRUE),
                            sum(data_arm_age12$Number_severe_asthma_attacks_during_followup, na.rm=TRUE)))

rownames(table_total) <- c("Follow up duration (year)","Nb of asthma attack during follow-up")
colnames(table_total) <- "Total"

## Follow-up duration in years
sum(data_arm_age12$Follow_up_duration_years_nozero, na.rm=TRUE)

table_sum_follow_up <- aggregate(data_arm_age12$Follow_up_duration_years_nozero, 
                                 by = list(Category=data_arm_age12$Enrolled_Trial_name), 
                                 FUN=sum)

table_sum_follow_up <- t(table_sum_follow_up)

colnames(table_sum_follow_up) <- table_sum_follow_up[1,]
table_sum_follow_up <- table_sum_follow_up[2,]

## Number of severe asthma attacks
sum(data_arm_age12$Number_severe_asthma_attacks_during_followup, na.rm=TRUE)

table_sum_asthma_attack <- aggregate(data_arm_age12$Number_severe_asthma_attacks_during_followup, 
                                     by = list(Category = data_arm_age12$Enrolled_Trial_name), 
                                     FUN=sum)

table_sum_asthma_attack <- t(table_sum_asthma_attack)
colnames(table_sum_asthma_attack) <- table_sum_asthma_attack[1,]
table_sum_asthma_attack <- table_sum_asthma_attack[2,]

## Create a new table with the total information
table_sum_follow_up_and_asthma_attack <- rbind(table_sum_follow_up,table_sum_asthma_attack)
rownames(table_sum_follow_up_and_asthma_attack)<- c("Follow up duration (year)","Nb of asthma attack during follow-up")
table_sum_follow_up_and_asthma_attack <- cbind(table_total, table_sum_follow_up_and_asthma_attack)

## Export the table for follow-up duration and asthma attack sum
write_xlsx(table_sum_follow_up_and_asthma_attack,"table_sum_follow_up_and_attack.xlsx")
```


# Truncation to 99th percentile

```{r, eval = FALSE}
# We truncated the values of all numerical variables with continuous values to the 99th percentile

# Check all variables and their column number
# Create a tibble (data frame) with the column numbers and their corresponding variable names
tibble(
  ColumnNumber = seq_along(data_arm_age12), # Sequence along the number of columns
  VariableName = names(data_arm_age12)) # Names of the columns
%>% print(n= 100) # Print the tibble
```

```{r, eval = FALSE}
# Specify the column numbers you want to truncate
columns_to_truncate <- c(22,24,44,46,48,50,58,62:87,94:97)
```

```{r, eval = FALSE}
# Truncate the specified columns with 0.05% as the lower bound and 99.5% as the upper bound
## This code is used only in R version 4.3.1

# Create a separate dataset for truncation
data_to_truncate <- data_arm_age12

cutoff <- function(data_to_truncate, var){
  # Apply Winsorization to the specified column
  data_to_truncate[,var] <- 
    Winsorize(data_to_truncate[,var],
          minval = quantile(data_to_truncate[,var], probs = 0.005, na.rm = TRUE), # 0.5% quantile as lower bound
          maxval = quantile(data_to_truncate[,var], probs = 0.995, na.rm = TRUE)) # 99.5% quantile as upper bound
}

# Loop through each column specified for truncation and apply the cutoff function
for (col in columns_to_truncate){
  data_to_truncate[,col] <- cutoff(data_to_truncate,var=col)
}
```


```{r, eval = FALSE}
# Truncate the specified columns with 0.05% as the lower bound and 99.5% as the upper bound
## This code is used in R version 4.4.1 and newer

# Create a separate dataset for truncation
data_to_truncate <- data_arm_age12

# Define a custom Winsorization function
cutoff <- function(data, var){
  # Calculate the 0.5% and 99.5% quantiles
  lower_bound <- quantile(data[[var]], probs = 0.005, na.rm = TRUE)
  upper_bound <- quantile(data[[var]], probs = 0.995, na.rm = TRUE)
  
  # Winsorize the data manually by replacing values outside the bounds
  data[[var]] <- pmax(pmin(data[[var]], upper_bound), lower_bound)
  
  return(data[[var]])  # Return the modified column
}

# Loop through each column specified for truncation and apply the cutoff function
for (col in columns_to_truncate){
  data_to_truncate[[col]] <- cutoff(data_to_truncate, var = col)
}

# Check the result
head(data_to_truncate)
```



```{r, eval = FALSE}
# Summarize specific variables before and after truncation

# Print summaries of the original dataset's variables
summary(data_arm_age12$Number_severe_attack_previous_12m_con)
summary(data_arm_age12$FEV1_preBD_PCT_Baseline)
summary(data_arm_age12$FeNO_baseline_ppb)

# Print summaries of the truncated dataset's variables to check if truncation worked
summary(data_to_truncate$Number_severe_attack_previous_12m_con) 
summary(data_to_truncate$FEV1_preBD_PCT_Baseline)
summary(data_to_truncate$FeNO_baseline_ppb)
```

```{r, eval = FALSE}
# Rename the truncated dataset to the original dataset name
data_arm_age12 <- data_to_truncate
```

# Single imputation with post-processing: Age

```{r, eval = FALSE}
# As described in Data cleaning, we received the variable Age as continuous and categorical variable depending on study
# This R code imputes values for Age continuous (Age_con), while restricting to the information provided by Age categorical (Age_cat), using the R package mice

## Add indicator variable for missing values in Age_con
data_arm_age12 <- data_arm_age12 %>%
  mutate(Age_con_0NA_1_2 =
           case_when(
             !is.na(Age_con) ~ 1,           
             is.na(Age_con) & is.na(Age_cat) ~ 2,
             is.na(Age_con) & !is.na(Age_cat) ~ 0
           ), .after = Age_con)

data_age_con <- data.frame(Sequential_number = data_arm_age12$Sequential_number, 
                           Age_con_0NA_1_2 = data_arm_age12$Age_con_0NA_1_2, 
                           Age_cat = data_arm_age12$Age_cat, 
                           Age_min = data_arm_age12$Age_min, 
                           Age_max = data_arm_age12$Age_max)

```

```{r, eval = FALSE}
# Check all variables and their column number

tibble(
  ColumnNumber = seq_along(data_arm_age12),
  VariableName = names(data_arm_age12)
  ) %>% print(n = 100)
```

```{r, eval = FALSE}
# Impute with mice but only keep the imputed values where we have no information on Age_cat (=NA)

set.seed(123) # set a seed to initialize the sequence of random numbers generated
data_imp_age_con <- data_arm_age12[,c(1,7,11,14,21,29,40,42,43,50,56:58,60:62,66,74,84:88)] # variables for the imputation model 

factors <- c(3,5:16)
data_imp_age_con <- data_imp_age_con %>% mutate(across(all_of(factors), as.factor)) # change data type to factor for factor variables

data_imp_age_con$BMI_con <- as.numeric(data_imp_age_con$BMI_con) # make sure BMI_con and Age_con are numeric variables before imputation
data_imp_age_con$Age_con <- as.numeric(data_imp_age_con$Age_con)

predM <- make.predictorMatrix(data_imp_age_con) # create predictor matrix 
predM["Sequential_number", ] <- 0 # set predictor matrix for sequential number to 0
predM[, "Sequential_number"] <- 0

imp_age_con <- mice(data_imp_age_con, m = 10, seed = 123, predictorMatrix = predM) # imputation model with 10 imputations and default of 5 iterations
imp_age_con$loggedEvents # check number of logged events
```

```{r, eval = FALSE}
# Check imputed values versus original values
densityplot(imp_age_con)
```

```{r, eval = FALSE}
# Choose one imputed data set and merge with data set we created previosuly containing Age_cat and the indicator variable
completed_imp_age_con <- mice::complete(imp_age_con, 10) # imputed data set 10
completed_imp_age_con <- merge(completed_imp_age_con, data_age_con, by = "Sequential_number")

# If Age_cat is available, put Age_con back to NA
completed_imp_age_con <- completed_imp_age_con %>%
  mutate(Age_con =
           case_when(
             Age_con_0NA_1_2 == 0 ~ NA,
             Age_con_0NA_1_2 == 1 ~ Age_con,
             Age_con_0NA_1_2 == 2 ~ Age_con
           ))
```

```{r, eval = FALSE}
# Replace missing values in Age_cat using newly imputed Age_con

completed_imp_age_con <- completed_imp_age_con %>%
  mutate(Age_cat = case_when(
    is.na(Age_cat) & Age_con >= 0 & Age_con <= 10 ~ "0 < x <= 10",
    is.na(Age_cat) & Age_con > 10 & Age_con <= 15 ~ "10 < x <= 15",
    is.na(Age_cat) & Age_con > 15 & Age_con <= 20 ~ "15 < x <= 20",
    is.na(Age_cat) & Age_con > 20 & Age_con <= 25 ~ "20 < x <= 25",
    is.na(Age_cat) & Age_con > 25 & Age_con <= 30 ~ "25 < x <= 30",
    is.na(Age_cat) & Age_con > 30 & Age_con <= 35 ~ "30 < x <= 35",
    is.na(Age_cat) & Age_con > 35 & Age_con <= 40 ~ "35 < x <= 40",
    is.na(Age_cat) & Age_con > 40 & Age_con <= 45 ~ "40 < x <= 45",
    is.na(Age_cat) & Age_con > 45 & Age_con <= 50 ~ "45 < x <= 50",
    is.na(Age_cat) & Age_con > 50 & Age_con <= 55 ~ "50 < x <= 55",
    is.na(Age_cat) & Age_con > 55 & Age_con <= 60 ~ "55 < x <= 60",
    is.na(Age_cat) & Age_con > 60 & Age_con <= 65 ~ "60 < x <= 65",
    is.na(Age_cat) & Age_con > 65 & Age_con <= 70 ~ "65 < x <= 70",
    is.na(Age_cat) & Age_con > 70 & Age_con <= 75 ~ "70 < x <= 75",
    is.na(Age_cat) & Age_con > 75 & Age_con <= 80 ~ "75 < x <= 80",
    is.na(Age_cat) & Age_con > 80 & Age_con <= 85 ~ "80 < x <= 85",
    is.na(Age_cat) & Age_con > 85 & Age_con <= 90 ~ "85 < x <= 90",
    TRUE ~ as.character(Age_cat)
  ))

```

```{r, eval = FALSE}
# Include Minimum value for check later

completed_imp_age_con <- completed_imp_age_con %>%
  mutate(Age_min =
           case_when(Age_cat == "12 <= x <= 33" ~ 12,
                     Age_cat == "12 <= x <= 42" ~ 12,
                     Age_cat == "18 <= x <= 38" ~ 18,
                     Age_cat == "18 <= x <= 41" ~ 18,
                     Age_cat == "33 < x <= 47" ~ 33.1,
                     Age_cat == "38 < x <= 48" ~ 38.1,
                     Age_cat == "41 < x <= 50" ~ 41.1,
                     Age_cat == "42 < x <= 51" ~ 42.1,
                     Age_cat == "47 < x <= 58" ~ 47.1,
                     Age_cat == "48 < x <= 58" ~ 48.1,
                     Age_cat == "50 < x <= 58" ~ 50.1,
                     Age_cat == "51 < x <= 59" ~ 51.1,
                     Age_cat == "58 < x <= 80" ~ 58.1,
                     Age_cat == "58 < x <= 84" ~ 58.1,
                     Age_cat == "58 < x <= 87" ~ 58.1,
                     Age_cat == "59 < x <= 82" ~ 59.1,
                     Age_cat == "0 < x <= 25" ~ 12,
                     Age_cat == "0 < x <= 10" ~ 0,
                     Age_cat == "10 < x <= 20" ~ 12,
                     Age_cat == "10 < x <= 15" ~ 12,
                     Age_cat == "15 < x <= 20" ~ 15.1,
                     Age_cat == "20 < x <= 25" ~ 20.1,
                     Age_cat == "20 < x <= 40" ~ 20.1,
                     Age_cat == "25 < x <= 30" ~ 25.1,
                     Age_cat == "25 < x <= 50" ~ 25.1,
                     Age_cat == "30 < x <= 35" ~ 30.1,
                     Age_cat == "35 < x <= 40" ~ 35.1,
                     Age_cat == "40 < x <= 45" ~ 40.1,
                     Age_cat == "45 < x <= 50" ~ 45.1,
                     Age_cat == "50 < x <= 55" ~ 50.1,
                     Age_cat == "50 < x <= 75" ~ 50.1,
                     Age_cat == "55 < x <= 60" ~ 55.1,
                     Age_cat == "60 < x <= 65" ~ 60.1,
                     Age_cat == "60 < x <= 80" ~ 60.1,
                     Age_cat == "65 < x <= 70" ~ 65.1,
                     Age_cat == "70 < x <= 75" ~ 70.1,
                     Age_cat == "20 < x <= 30" ~ 20.1,
                     Age_cat == "30 < x <= 40" ~ 30.1,
                     Age_cat == "40 < x <= 50" ~ 40.1,
                     Age_cat == "50 < x <= 60" ~ 50.1,
                     Age_cat == "60 < x <= 70" ~ 60.1,
                     Age_cat == "70 < x <= 80" ~ 70.1,
                     Age_cat == "75 < x <= 80" ~ 75.1,
                     Age_cat == "80 < x <= 85" ~ 80.1,
                     Age_cat == "85 < x <= 90" ~ 85.1,))
```

```{r, eval = FALSE}
# Include Maximum value for check later

completed_imp_age_con <- completed_imp_age_con %>%
  mutate(Age_max =
           case_when(Age_cat == "12 <= x <= 33" ~ 33,
                     Age_cat == "12 <= x <= 42" ~ 42,
                     Age_cat == "18 <= x <= 38" ~ 38,
                     Age_cat == "18 <= x <= 41" ~ 41,
                     Age_cat == "33 < x <= 47" ~ 47,
                     Age_cat == "38 < x <= 48" ~ 48,
                     Age_cat == "41 < x <= 50" ~ 50,
                     Age_cat == "42 < x <= 51" ~ 51,
                     Age_cat == "47 < x <= 58" ~ 58,
                     Age_cat == "48 < x <= 58" ~ 58,
                     Age_cat == "50 < x <= 58" ~ 58,
                     Age_cat == "51 < x <= 59" ~ 59,
                     Age_cat == "58 < x <= 80" ~ 80,
                     Age_cat == "58 < x <= 84" ~ 84,
                     Age_cat == "58 < x <= 87" ~ 87,
                     Age_cat == "59 < x <= 82" ~ 82,
                     Age_cat == "0 < x <= 25" ~ 25,
                     Age_cat == "0 < x <= 10" ~ 10,
                     Age_cat == "10 < x <= 20" ~ 20,
                     Age_cat == "10 < x <= 15" ~ 15,
                     Age_cat == "15 < x <= 20" ~ 20,
                     Age_cat == "20 < x <= 25" ~ 25,
                     Age_cat == "20 < x <= 40" ~ 40,
                     Age_cat == "25 < x <= 30" ~ 30,
                     Age_cat == "25 < x <= 50" ~ 50,
                     Age_cat == "30 < x <= 35" ~ 35,
                     Age_cat == "35 < x <= 40" ~ 40,
                     Age_cat == "40 < x <= 45" ~ 45,
                     Age_cat == "45 < x <= 50" ~ 50,
                     Age_cat == "50 < x <= 55" ~ 55,
                     Age_cat == "50 < x <= 75" ~ 75,
                     Age_cat == "55 < x <= 60" ~ 60,
                     Age_cat == "60 < x <= 65" ~ 65,
                     Age_cat == "60 < x <= 80" ~ 80,
                     Age_cat == "65 < x <= 70" ~ 70,
                     Age_cat == "70 < x <= 75" ~ 75,
                     Age_cat == "20 < x <= 30" ~ 30,
                     Age_cat == "30 < x <= 40" ~ 40,
                     Age_cat == "40 < x <= 50" ~ 50,
                     Age_cat == "50 < x <= 60" ~ 60,
                     Age_cat == "60 < x <= 70" ~ 70,
                     Age_cat == "70 < x <= 80" ~ 80,
                     Age_cat == "75 < x <= 80" ~ 80,
                     Age_cat == "80 < x <= 85" ~ 85,
                     Age_cat == "85 < x <= 90" ~ 90,))

```

```{r, eval = FALSE}
# Take out the Age variables from completed_imp_age_con, because these should not be imputed

data_imp_age2 <- data.frame(Sequential_number = completed_imp_age_con$Sequential_number, 
                            Age_con = completed_imp_age_con$Age_con, 
                            Age_cat = completed_imp_age_con$Age_cat, 
                            Age_min = completed_imp_age_con$Age_min, 
                            Age_max = completed_imp_age_con$Age_max, 
                            Age_con_0NA_1_2 = completed_imp_age_con$Age_con_0NA_1_2)

```

```{r, eval = FALSE}
# Now impute Age_con using the restrictions of the completed variable Age_cat

set.seed(123) # set the same seed

data_imp_age <- data_arm_age12[, c(1,11,14,21,29,40,42,43,50,56:58,60:62,66,74,84:88)] # do not include Age_con
data_imp_age2 <- merge(data_imp_age2, data_imp_age, by = "Sequential_number")

factors <- c(7,9:20)
data_imp_age2 <- data_imp_age2 %>% mutate(across(all_of(factors), as.factor))

data_imp_age2$Age_cat <- as.character(data_imp_age2$Age_cat)

predM <- make.predictorMatrix(data_imp_age2)
predM[c("Sequential_number","Age_min","Age_max","Age_con_0NA_1_2"), ] <- 0 # define the predictor matrix with variables that should not be used as a predictor for the target variable in the imputation model
predM[, c("Sequential_number","Age_min","Age_max","Age_con_0NA_1_2")] <- 0

```

```{r, eval = FALSE}
# Use post-processing to squeeze Age_con within the boundaries that we know by Age_cat

post <- make.post(data_imp_age2)

post_first = "imp[[j]][data_imp_age2$Age_cat[!r[, j]] == '"; post_second = "', i] <- squeeze(imp[[j]][data_imp_age2$Age_cat[!r[, j]] == '"
post_third = "', i], c("; post_fourth = "))"

intervals <- unique(data_imp_age2$Age_cat)
len_intervals = length(intervals)
int_mat <- matrix(nrow = len_intervals, ncol = 2)
for (i in 1:len_intervals) {
  bounds <- unlist(strsplit(intervals[i], " <= | < "))
  lower <- as.numeric(gsub("x", "", bounds[1]))
  upper <- as.numeric(gsub("x", "", bounds[3]))
  int_mat[i, ] <- c(lower, upper)
  
  if (grepl("< x", intervals[i])) {
    lower <- lower + 1
  }
  
  int_mat[i, ] <- c(lower, upper)
}

test = NULL
for(i in 1:len_intervals){
  test = paste(test, paste(post_first, intervals[i], post_second, intervals[i], post_third, paste(int_mat[i, ], collapse = ", "), post_fourth, "\n", sep = ""), sep = "")
}
post["Age_con"] = test

```

```{r, eval = FALSE}
# Use mice to perform multiple imputation

imp_age2 <- mice(data_imp_age2, m = 10, post = post, seed = 123, predictorMatrix = predM)
imp_age2$loggedEvents
```

```{r, eval = FALSE}
# Check imputed values versus original values
densityplot(imp_age2)
```


```{r, eval = FALSE}
# Choose one imputed data set
completed_imp_age2 <- mice::complete(imp_age2, 10)

# Check if the squeezing worked using minimum and maximum
completed_imp_age2$Check_Agemin = completed_imp_age2$Age_con >= completed_imp_age2$Age_min
completed_imp_age2$Check_Agemax = completed_imp_age2$Age_con <= completed_imp_age2$Age_max
nrow(filter(completed_imp_age2, Check_Agemin == FALSE)) # should be 0
nrow(filter(completed_imp_age2, Check_Agemax == FALSE)) # should be 0
```

```{r, eval = FALSE}
sum(is.na(completed_imp_age2$Age_con)) # must be 0 

# Now data frame completed_imp_age2 has the imputed Age_con with 0 missing values
```

# Single imputation with post-processing: BMI

```{r, eval = FALSE}
# As described in Data cleaning, we received the variable BMI as continuous and categorical variable depending on study
# This R code imputes values for BMI continuous (BMI_con), while restricting to the information provided by BMI categorical (BMI_cat), using the R package mice

## Add indicator variable for missing values in BMI_con
data_arm_age12 <- data_arm_age12 %>%
  mutate(BMI_con_0NA_1_2 =
           case_when(
             !is.na(BMI_con) ~ 1,           
             is.na(BMI_con) & is.na(BMI_cat) ~ 2,
             is.na(BMI_con) & !is.na(BMI_cat) ~ 0
           ), .after = BMI_con)

data_bmi_con <- data.frame(Sequential_number = data_arm_age12$Sequential_number, 
                           BMI_con_0NA_1_2 = data_arm_age12$BMI_con_0NA_1_2, 
                           BMI_cat = data_arm_age12$BMI_cat, 
                           BMI_min = data_arm_age12$BMI_min, 
                           BMI_max = data_arm_age12$BMI_max)

```

```{r, eval = FALSE}
# Check all variables and their column number

tibble(
  ColumnNumber = seq_along(data_arm_age12),
  VariableName = names(data_arm_age12)
  ) %>% print(n= 100)
```

```{r, eval = FALSE}
# Impute with mice but only keep the imputed values where BMI_cat = NA

set.seed(123)

data_imp_bmi_con <- data_arm_age12[, c(1,7,11,14,22,30,41,43,44,51,57:59,61:63,67,75,85:89)] # variables to be imputed 

factors <- c(3,5:16)
data_imp_bmi_con <- data_imp_bmi_con %>% mutate(across(all_of(factors), as.factor))

predM <- make.predictorMatrix(data_imp_bmi_con) # create predictor matrix for mice model
predM["Sequential_number", ] <- 0 
predM[, "Sequential_number"] <- 0

imp_bmi_con <- mice(data_imp_bmi_con, m = 10, seed = 123, predictorMatrix = predM)
imp_bmi_con$loggedEvents # check logged events
```

```{r, eval = FALSE}
# Check imputed values versus original values
densityplot(imp_bmi_con)
```

```{r, eval = FALSE}
# Choose one imputed data set and merge with data set containing BMI_cat and the indicator variable
completed_imp_bmi_con <- mice::complete(imp_bmi_con, 10)
sum(is.na(completed_imp_bmi_con$BMI_con)) # must be 0

completed_imp_bmi_con <- merge(completed_imp_bmi_con, data_bmi_con, by = "Sequential_number")

# If BMI_cat is available, put BMI_con back to NA
completed_imp_bmi_con <- completed_imp_bmi_con %>%
  mutate(BMI_con =
           case_when(
             BMI_con_0NA_1_2 == 0 ~ NA,
             BMI_con_0NA_1_2 == 1 ~ BMI_con,
             BMI_con_0NA_1_2 == 2 ~ BMI_con
           ))
```

```{r, eval = FALSE}
# Replace missing values in BMI_cat using newly imputed BMI_con
completed_imp_bmi_con <- completed_imp_bmi_con %>%
  mutate(BMI_cat = case_when(
        is.na(BMI_cat) & BMI_con <= 19 ~ "0 < x <= 19",
        is.na(BMI_cat) & BMI_con > 19 & BMI_con <= 25 ~ "19 < x <= 25",
        is.na(BMI_cat) & BMI_con > 25 & BMI_con <= 30 ~ "25 < x <= 30",
        is.na(BMI_cat) & BMI_con > 30 & BMI_con <= 35 ~ "30 < x <= 35",
        is.na(BMI_cat) & BMI_con > 35 & BMI_con <= 40 ~ "35 < x <= 40",
        is.na(BMI_cat) & BMI_con > 40  ~ "40 < x",
        TRUE ~ as.character(BMI_cat)
      ))
```

```{r, eval = FALSE}
# Include Minimum for check later
completed_imp_bmi_con <- completed_imp_bmi_con %>%
  mutate(BMI_min =
           case_when(BMI_cat == "0 < x <= 19" ~ 0.001,
                     BMI_cat == "19 < x <= 25" ~ 19.001,
                     BMI_cat == "25 < x <= 30" ~ 25.001,
                     BMI_cat == "30 < x <= 80" ~ 30.001,
                     BMI_cat == "30 < x <= 35" ~ 30.001,
                     BMI_cat == "35 < x <= 40" ~ 35.001,
                     BMI_cat == "40 < x" ~ 40.001))

```

```{r, eval = FALSE}
# Include Maximum for check later 
completed_imp_bmi_con <- completed_imp_bmi_con %>%
  mutate(BMI_max =
           case_when(BMI_cat == "0 < x <= 19" ~ 19,
                     BMI_cat == "19 < x <= 25" ~ 25,
                     BMI_cat == "25 < x <= 30" ~ 30,
                     BMI_cat == "30 < x <= 80" ~ 80,
                     BMI_cat == "30 < x <= 35" ~ 35,
                     BMI_cat == "35 < x <= 40" ~ 40,
                     BMI_cat == "40 < x" ~ 80))
```

```{r, eval = FALSE}
# Take out the BMI variables from completed_imp_bmi_con, because these should not be imputed anymore
data_imp_bmi2 <- data.frame(Sequential_number = completed_imp_bmi_con$Sequential_number, 
                            BMI_con = completed_imp_bmi_con$BMI_con, 
                            BMI_cat = completed_imp_bmi_con$BMI_cat, 
                            BMI_min = completed_imp_bmi_con$BMI_min, 
                            BMI_max = completed_imp_bmi_con$BMI_max, 
                            BMI_con_0NA_1_2 = completed_imp_bmi_con$BMI_con_0NA_1_2)

```

```{r, eval = FALSE}
# Now impute BMI_con using the boundaries of the completed BMI_cat
set.seed(123)

data_imp_bmi <- data_arm_age12[, c(1,7,11,22,30,41,43,44,51,57:59,61:63,67,75,85:89)] # do not include BMI_con

data_imp_bmi2 <- merge(data_imp_bmi2, data_imp_bmi, by = "Sequential_number")

factors <- c(8:20)
data_imp_bmi2 <- data_imp_bmi2 %>% mutate(across(all_of(factors), as.factor))

predM <- make.predictorMatrix(data_imp_bmi2) # create predictor matrix
predM[c("Sequential_number","BMI_min","BMI_max","BMI_cat","BMI_con_0NA_1_2"), ] <- 0 # add variables that should not be used as a predictor in the imputation model
predM[, c("Sequential_number","BMI_min","BMI_max","BMI_cat","BMI_con_0NA_1_2")] <- 0
```

```{r, eval = FALSE}
# Use post-processing to squeeze BMI_con within boundaries of BMI_cat
post <- make.post(data_imp_bmi2)

post_first = "imp[[j]][data_imp_bmi2$BMI_cat[!r[, j]] == '"; post_second = "', i] <- squeeze(imp[[j]][data_imp_bmi2$BMI_cat[!r[, j]] == '"
post_third = "', i], c("; post_fourth = "))"

intervals <- unique(data_imp_bmi2$BMI_cat)
len_intervals = length(intervals)
int_mat <- matrix(nrow = len_intervals, ncol = 2)
for (i in 1:len_intervals) {
  bounds <- unlist(strsplit(intervals[i], " <= | < "))
  lower <- as.numeric(gsub("x", "", bounds[1]))
  upper <- as.numeric(gsub("x", "", bounds[3]))
  int_mat[i, ] <- c(lower, upper)
  
  if (grepl("< x", intervals[i])) {
    lower <- lower + 0.001
  }
  
  if (grepl("40 < x", intervals[i])) {
    upper <- 80
  }
  
  int_mat[i, ] <- c(lower, upper)
}

test = NULL
for(i in 1:len_intervals){
  test = paste(test, paste(post_first, intervals[i], post_second, intervals[i], post_third, paste(int_mat[i, ], collapse = ", "), post_fourth, "\n", sep = ""), sep = "")
}
post["BMI_con"] = test
```

```{r, eval = FALSE}
# Use mice to perform multiple imputation
imp_bmi2 <- mice(data_imp_bmi2, m = 10, post=post, seed = 123, predictorMatrix = predM)
imp_bmi2$loggedEvents # check logged events
```

```{r, eval = FALSE}
# Check imputed versus original values
densityplot(imp_bmi2)
```

```{r, eval = FALSE}
# Choose one imputed data set
completed_imp_bmi2 <- mice::complete(imp_bmi2, 10)

# Check if the squeezing worked using minimum and maximum
completed_imp_bmi2$Check_BMImin = completed_imp_bmi2$BMI_con >= completed_imp_bmi2$BMI_min
completed_imp_bmi2$Check_BMImax = completed_imp_bmi2$BMI_con <= completed_imp_bmi2$BMI_max
nrow(filter(completed_imp_bmi2, Check_BMImin == FALSE)) # should be 0
nrow(filter(completed_imp_bmi2, Check_BMImax == FALSE)) # should be 0
```

```{r, eval = FALSE}
sum(is.na(completed_imp_bmi2$BMI_con)) # should be 0

# Now data frame completed_imp_bmi2 has the imputed BMI_con with 0 missing values
```


# Single imputation with post-processing: Pack years

```{r, eval = FALSE}
# As described in Data cleaning, we received the variable Pack years as continuous and categorical variable depending on study
# This R code imputes values for Pack years continuous (Pack_years_con), while restricting to the information provided by Pack years categorical (Pack_years_cat), using the R package mice

# Add indicator variable for NAs in Pack_years_con
data_arm_age12 <- data_arm_age12 %>%
  mutate(PackY_con_0NA_1_2 =
           case_when(
             !is.na(Pack_years_con) ~ 1,           
             is.na(Pack_years_con) & is.na(Pack_years_cat) ~ 2,
             is.na(Pack_years_con) & !is.na(Pack_years_cat) ~ 0
           ), .after = Pack_years_con)

data_packY_con <- data.frame(Sequential_number = data_arm_age12$Sequential_number, 
                             PackY_con_0NA_1_2 = data_arm_age12$PackY_con_0NA_1_2, 
                             Pack_years_cat = data_arm_age12$Pack_years_cat, 
                             Pack_years_min = data_arm_age12$Pack_years_min, 
                             Pack_years_max = data_arm_age12$Pack_years_max)

```

```{r, eval = FALSE}
# Check all variables and their column number

tibble(
  ColumnNumber = seq_along(data_arm_age12),
  VariableName = names(data_arm_age12)
  ) %>% print(n= 110)
```

```{r, eval = FALSE}
# Impute with mice but only keep values where Pack_years_cat = NA
set.seed(123)

data_imp_packy_con <- data_arm_age12[, c(1,7,11,14,22,30,32,42,44,45,52,58:60,62:64,68,76,86:90)] # variables to be imputed 

factors <- c(3,5,6,8:17)
data_imp_packy_con <- data_imp_packy_con %>% mutate(across(all_of(factors), as.factor))

predM <- make.predictorMatrix(data_imp_packy_con) # create predictor matrix
predM["Sequential_number", ] <- 0 
predM[, "Sequential_number"] <- 0

imp_packy_con <- mice(data_imp_packy_con, m = 10, seed = 123, predictorMatrix = predM)
imp_packy_con$loggedEvents # check logged events
```

```{r, eval = FALSE}
# Check imputed versus original values
densityplot(imp_packy_con)
```

```{r, eval = FALSE}
# Choose one imputed data set and merge
completed_imp_packy_con <- mice::complete(imp_packy_con, 10)
sum(is.na(completed_imp_packy_con$Pack_years_con)) # must be 0

completed_imp_packy_con <- merge(completed_imp_packy_con, data_packY_con, by = "Sequential_number")

# If Pack_years_cat is available, put Pack_years_con back to NA
completed_imp_packy_con <- completed_imp_packy_con %>%
  mutate(Pack_years_con =
           case_when(
             PackY_con_0NA_1_2 == 0 ~ NA,
             PackY_con_0NA_1_2 == 1 ~ Pack_years_con,
             PackY_con_0NA_1_2 == 2 ~ Pack_years_con
           ))

```

```{r, eval = FALSE}
# Replace NA in Pack_years_cat using newly imputed Pack_years_con
completed_imp_packy_con <- completed_imp_packy_con %>%
  mutate(Pack_years_cat = case_when(
    is.na(Pack_years_cat) & Pack_years_con > 0 & Pack_years_con < 10 ~ "<10 cigarettes per day",
    is.na(Pack_years_cat) & Pack_years_con >= 10 ~ ">=10 cigarettes per day",
    is.na(Pack_years_cat) & Pack_years_con == 0  ~ "0 cigarettes per day",
    TRUE ~ as.character(Pack_years_cat)
  ))

sum(is.na(completed_imp_packy_con$Pack_years_cat)) # should be 0
```

```{r, eval = FALSE}
# Include Minimum for check later
completed_imp_packy_con <- completed_imp_packy_con %>%
  mutate(Pack_years_min =
           case_when(Pack_years_cat == "<10 cigarettes per day" ~ 0.001,
                     Pack_years_cat == ">=10 cigarettes per day" ~ 10,
                     Pack_years_cat == "0 cigarettes per day" ~ 0))
```

```{r, eval = FALSE}
# Include Maximum for check later
completed_imp_packy_con <- completed_imp_packy_con %>%
  mutate(Pack_years_max =
           case_when(Pack_years_cat == "<10 cigarettes per day" ~ 9.9,
                     Pack_years_cat == ">=10 cigarettes per day" ~ 20,
                     Pack_years_cat == "0 cigarettes per day" ~ 0))
```

```{r, eval = FALSE}
# Take out the Pack years variables from completed_imp_packy_con, because these should not be imputed
data_imp_packY2 <- data.frame(Sequential_number = completed_imp_packy_con$Sequential_number, 
                              Pack_years_con = completed_imp_packy_con$Pack_years_con, 
                              Pack_years_cat = completed_imp_packy_con$Pack_years_cat, 
                              Pack_years_min = completed_imp_packy_con$Pack_years_min, 
                              Pack_years_max = completed_imp_packy_con$Pack_years_max, 
                              PackY_con_0NA_1_2 = completed_imp_packy_con$PackY_con_0NA_1_2)
```

```{r, eval = FALSE}
# Now impute Pack_years_con using the restrictions of the completed Pack_years_cat
set.seed(123)

data_imp_packY <- data_arm_age12[, c(1,7,11,14,22,30,42,44,45,52,58:60,62:64,68,76,86:90)] # variables to be imputed; make sure to leave out Pack_years_con
data_imp_packY2 <- merge(data_imp_packY2, data_imp_packY, by = "Sequential_number")

factors <- c(6,8,10:21)
data_imp_packY2 <- data_imp_packY2 %>% mutate(across(all_of(factors), as.factor))

predM <- make.predictorMatrix(data_imp_packY2) # create predictor matrix
predM[c("Sequential_number","PackY_con_0NA_1_2","Pack_years_min", "Pack_years_max"), ] <- 0 
predM[, c("Sequential_number","PackY_con_0NA_1_2","Pack_years_min", "Pack_years_max")] <- 0
```

```{r, eval = FALSE}
# Use post-processing to squeeze Pack_years_con within boundaries of Pack_years_cat
post <- make.post(data_imp_packY2)

post["Pack_years_con"] <- "imp[[j]][data_imp_packY2$Pack_years_cat[!r[, j]] == '<10 cigarettes per day', i] <- squeeze(imp[[j]][data_imp_packY2$Pack_years_cat[!r[, j]] == '<10 cigarettes per day', i], c(0.001, 9.9))
imp[[j]][data_imp_packY2$Pack_years_cat[!r[, j]] == '>=10 cigarettes per day', i] <- squeeze(imp[[j]][data_imp_packY2$Pack_years_cat[!r[, j]] == '>=10 cigarettes per day', i], c(10, 20))
imp[[j]][data_imp_packY2$Pack_years_cat[!r[, j]] == '0 cigarettes per day', i] <- squeeze(imp[[j]][data_imp_packY2$Pack_years_cat[!r[, j]] == '0 cigarettes per day', i], c(0, 0))
"

```

```{r, eval = FALSE}
imp_packy <- mice(data_imp_packY2, m = 10, post=post, seed = 123, predictorMatrix = predM)
imp_packy$loggedEvents # check logged events
```

```{r, eval = FALSE}
# Check imputed versus original values
densityplot(imp_packy)
```


```{r, eval = FALSE}
# Choose one imputed data set
completed_imp_packy <- mice::complete(imp_packy, 10)

# Check if the squeezing worked using minimum and maximum
completed_imp_packy$Check_PackYmin = completed_imp_packy$Pack_years_con >= completed_imp_packy$Pack_years_min
completed_imp_packy$Check_PackYmax = completed_imp_packy$Pack_years_con <= completed_imp_packy$Pack_years_max

nrow(filter(completed_imp_packy, Check_PackYmin == FALSE)) # should be 0
nrow(filter(completed_imp_packy, Check_PackYmax == FALSE)) # should be 0

sum(is.na(completed_imp_packy$Pack_years_con)) # should be 0

# Now data frame completed_imp_packy has the imputed Pack_years_con
```


# Creating new data frame with (single) imputed variables Age, BMI and Pack years

```{r, eval = FALSE}
# Put the imputed variables into new data frames
data_age_con_final <- data.frame(Age = completed_imp_age2$Age_con, 
                                 Sequential_number = completed_imp_age2$Sequential_number)

data_bmi_con_final <- data.frame(BMI = completed_imp_bmi2$BMI_con, 
                                 Sequential_number = completed_imp_bmi2$Sequential_number)

data_packy_con_final <- data.frame(Pack_years = completed_imp_packy$Pack_years_con, 
                                   Sequential_number = completed_imp_packy$Sequential_number)

```

```{r, eval = FALSE}
# Remove the variables from original data set
data_arm_age12.SI <- data_arm_age12[,!names(data_arm_age12) %in% 
                                      c("Age", 
                                        "Age_cat", 
                                        "Age_con", 
                                        "Age_min", 
                                        "Age_max", 
                                        "Age_con_0NA_1_2", 
                                        "BMI", 
                                        "BMI_cat", 
                                        "BMI_con", 
                                        "BMI_min", 
                                        "BMI_max", 
                                        "BMI_con_0NA_1_2", 
                                        "Pack_years", 
                                        "Pack_years_cat", 
                                        "Pack_years_con", 
                                        "Pack_years_min", 
                                        "Pack_years_max",
                                        "PackY_con_0NA_1_2")]

```

```{r, eval = FALSE}
# Merge data sets by Sequential number
data_arm_age12.SI <- merge(data_arm_age12.SI, data_age_con_final, by = "Sequential_number")
data_arm_age12.SI <- merge(data_arm_age12.SI, data_bmi_con_final, by = "Sequential_number")
data_arm_age12.SI <- merge(data_arm_age12.SI, data_packy_con_final, by = "Sequential_number")

```

```{r, eval = FALSE}
# Change order of variables to maintain original structure
data_arm_age12.SI <- data_arm_age12.SI[,c(1:4,83,5,84,6:18,85,19:82)]

```

```{r, eval = FALSE}
# Write and save as .csv file
write.csv(data_arm_age12.SI, 'Network:/file.csv', row.names = FALSE)

```


# Multiple imputation by chained equation (mice)

```{r, eval = FALSE}
# The dataset consists of many variables/columns; for the optimal mice model, we should choose which variables to impute

# For lung function measures, check which ones have the lowest % of missing
# Create a named vector with the NA counts for each variable
na_counts <- c(
  FEV1_PCT_reversibility_postBD = sum(is.na(data_arm_age12.SI$FEV1_PCT_reversibility_postBD)),
  FEV1_postBD_PCT_Baseline = sum(is.na(data_arm_age12.SI$FEV1_postBD_PCT_Baseline)),
  FEV1_postBD_L_Baseline = sum(is.na(data_arm_age12.SI$FEV1_postBD_L_Baseline)),
  FEV1_preBD_PCT_Baseline = sum(is.na(data_arm_age12.SI$FEV1_preBD_PCT_Baseline)),
  FEV1_preBD_L_Baseline = sum(is.na(data_arm_age12.SI$FEV1_preBD_L_Baseline)),
  FEV1_predicted_L = sum(is.na(data_arm_age12.SI$FEV1_predicted_L)),
  FVC_preBD_L_Baseline = sum(is.na(data_arm_age12.SI$FVC_preBD_L_Baseline)),
  FVC_preBD_PCT_Baseline = sum(is.na(data_arm_age12.SI$FVC_preBD_PCT_Baseline)),
  FVC_postBD_L_Baseline = sum(is.na(data_arm_age12.SI$FVC_postBD_L_Baseline)),
  FVC_predicted_L = sum(is.na(data_arm_age12.SI$FVC_predicted_L)),
  FVC_postBD_PCT_Baseline = sum(is.na(data_arm_age12.SI$FVC_postBD_PCT_Baseline))
)

# Convert the vector to a data frame
na_counts_df <- data.frame(Variable = names(na_counts), NA_Count = na_counts)

# Sort the data frame by the NA counts from lowest to highest
na_counts_df_sorted <- na_counts_df[order(na_counts_df$NA_Count), ]

```


```{r, eval = FALSE}
# Check all variables and their column numbers
tibble(
  ColumnNumber = seq_along(data_arm_age12.SI),
  VariableName = names(data_arm_age12.SI)
  ) %>% print(n= 90)
```


```{r, eval = FALSE}
# Prepare the data frame by removing variables that will not be used for further analysis
## By removing variables, you can choose which variables you want to have imputed in the next step

data_arm_age12.SIshort <- data_arm_age12.SI[,!names(data_arm_age12.SI) %in% 
                                              c("ICS_TYPE", 
                                                "ICS_Dose_PER_DAY", 
                                                "ICS_DOSE_CLASS",  
                                                "ACT_baseline_score",
                                                "Blood_Eos_baseline_x10_9_cells_per_L", 
                                                "Country", 
                                                "Number_severe_attack_previous_12m", 
                                                "Number_hospitalisations_for_asthma_previous_12_months",
                                                "Psychiatric_disease_0no_1yes_9999notknown", 
                                                "Atopy_history_0no_1yes_9999notknown_COMPUTED",
                                                "Adherence_PreTrial_quality", 
                                                "Previous_ICU_0no_1yes_9999notknown", 
                                                "Previous_Intubation_0no_1yes_9999notknown", 
                                                "Adherence_InTrial_quality","FEV1_predicted_L",
                                                "FVC_predicted_L", 
                                                "FVC_postBD_PCT_Baseline", 
                                                "FVC_preBD_PCT_Baseline", 
                                                "FEV1PREBD_L_52W", 
                                                "FEV1PREBD_PCT_52W", 
                                                "FEV1POSTBD_L_52W",
                                                "FEV1POSTBD_PCT_52W", 
                                                "ACQ_baseline_score_item1_sleepawakenings", 
                                                "ACQ_baseline_score_item2_morningsymptoms", 
                                                "ACQ_baseline_score_item3_activitylimitation", 
                                                "ACQ_baseline_score_item4_dyspnea", 
                                                "ACQ_baseline_score_item5_wheezing", 
                                                "ACQ_baseline_score_item6_RelieverUse", 
                                                "ACQ_baseline_score_item7_FEV1", 
                                                "ICS_DOSE_CLASS", 
                                                "End_FollowUp_Reason")]

```

```{r, eval = FALSE}
# Check all variables and their column numbers
tibble(
  ColumnNumber = seq_along(data_arm_age12.SIshort),
  VariableName = names(data_arm_age12.SIshort)
  ) %>% print(n= 100)
```

```{r, eval = FALSE}
# Make sure all variables have the correct data type, e.g. factor, numeric or character

factors <- c(3,4,6,8:11,14,15,17:24,28,30:33,35:37)
data_arm_age12.SIshort <- data_arm_age12.SIshort %>% mutate(across(all_of(factors), as.factor))

numeric <- c(1,5,7,12,13,16,25:27,29,34,38:55)
data_arm_age12.SIshort <- data_arm_age12.SIshort %>% mutate(across(all_of(numeric), as.numeric))

data_arm_age12.SIshort$Subject_ID <- as.character(data_arm_age12.SIshort$Subject_ID)
```

```{r, eval = FALSE}
# Relevel factor variables, e.g. treatment step reference = step 3 and sex reference = male

data_arm_age12.SIshort$Treatment_step <- relevel(data_arm_age12.SIshort$Treatment_step, ref = "3")
data_arm_age12.SIshort$Gender_0Female_1Male <- relevel(data_arm_age12.SIshort$Gender_0Female_1Male, ref = "1")
```

```{r, eval = FALSE}
# Log-transform variables

data_arm_age12.SIshort$FeNO_baseline_ppb <- log(data_arm_age12.SIshort$FeNO_baseline_ppb, base=10)
data_arm_age12.SIshort$Total_IgE <- log(data_arm_age12.SIshort$Total_IgE, base=10)
data_arm_age12.SIshort$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced <- log(data_arm_age12.SIshort$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced, base=10)
data_arm_age12.SIshort$Follow_up_duration_days <- log(data_arm_age12.SIshort$Follow_up_duration_days)
```

```{r, eval = FALSE}
# Prepare the multiple imputation model

## Define method used for the imputation per variable
method <- c("","","","","pmm","logreg","pmm","polyreg","polyreg","pmm",
            "logreg","pmm","pmm","logreg","polr","pmm","polyreg","logreg","logreg","logreg",
            "logreg","logreg","logreg","logreg","pmm","pmm","pmm","logreg","pmm","logreg",
            "logreg","logreg","logreg","pmm","logreg","logreg","logreg","pmm","pmm","pmm",
            "pmm","pmm","pmm","pmm","pmm","pmm","pmm","pmm","pmm","pmm",
            "pmm","pmm","pmm", "pmm", "pmm")

## Create a predictor matrix
predM <- make.predictorMatrix(data_arm_age12.SIshort)

## Add variables to predictor matrix that should not be used as a predictor to impute the target variable(s)
predM[c("Sequential_number",
        "Subject_ID",
        "Treatment_arm",
        "Time_to_First_attack", 
        "Time_to_2n_attack", 
        "Time_to_3n_attack", 
        "Time_to_4n_attack", 
        "Time_to_5n_attack", 
        "Enrolled_Trial_name") , ] <- 0

predM[, c("Sequential_number",
          "Subject_ID",
          "Treatment_arm",
          "Time_to_First_attack",
          "Time_to_2n_attack", 
          "Time_to_3n_attack", 
          "Time_to_4n_attack", 
          "Time_to_5n_attack", 
          "Enrolled_Trial_name")] <- 0
```

```{r, eval = FALSE}
# Multiple imputation with mice

## M = 10 creates 10 imputed data sets, Maxit = 30 gives 30 iterations
## Define your method and predictor matrix, and set the seed 
imp_data_ORACLE_final_20240918 <- 
  mice(data_arm_age12.SIshort, m = 10, maxit = 30, method = method, seed = 123, predictorMatrix = predM, printFlag = FALSE)

imp_data_ORACLE_final_20240918$loggedEvents # check logged events
```

```{r, eval = FALSE}
# Check convergence of the imputed data sets
plot(imp_data_ORACLE_final_20240918)
```

```{r, eval = FALSE}
# Write and save as R object file
saveRDS(imp_data_ORACLE_final_20240918, file="imp_data_ORACLE_final_20241002.RData")
```


# Complete imputed data sets 

```{r, eval = FALSE}
# For the analyses, we create two completed data sets: one in which the systematically missing values are not replaced (=NR) and there are thus no missing values, and one in which the systematically missing values are put back to NA

imp_data_ORACLE_final_COMP_NR = mice::complete(imp_data_ORACLE_final_20241002, action = "long")
imp_data_ORACLE_final_COMP = mice::complete(imp_data_ORACLE_final_20241002, action = "long")
```

```{r, eval = FALSE}
# For dataset imp_data_ORACLE_final_COMP
# Replace the imputed time-to-first-attack values with NA if there was no attack recorded
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(Time_to_First_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup > 0 ~ Time_to_First_attack
  ))

# Replace the imputed time-to-second-attack values with NA if there was no second attack recorded
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(Time_to_2n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup > 1 ~ Time_to_2n_attack
  ))

# Replace the imputed time-to-third-attack values with NA if there was no third attack recorded
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(Time_to_3n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup == 2 ~ NA,
    Number_severe_asthma_attacks_during_followup > 2 ~ Time_to_3n_attack
  ))

# Replace the imputed time-to-fourth-attack values with NA if there was no fourth attack recorded
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(Time_to_4n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup == 2 ~ NA,
    Number_severe_asthma_attacks_during_followup == 3 ~ NA,
    Number_severe_asthma_attacks_during_followup > 3 ~ Time_to_4n_attack
  ))

# Replace the imputed time-to-fifth-attack values with NA if there was no fifth attack recorded
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(Time_to_5n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup == 2 ~ NA,
    Number_severe_asthma_attacks_during_followup == 3 ~ NA,
    Number_severe_asthma_attacks_during_followup == 4 ~ NA,
    Number_severe_asthma_attacks_during_followup > 4 ~ Time_to_5n_attack
  ))

```

```{r, eval = FALSE}
# For dataset imp_data_ORACLE_final_COMP_NR
# Replace the imputed time-to-first-attack values with NA if there was no attack recorded
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(Time_to_First_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup > 0 ~ Time_to_First_attack
  ))

# Replace the imputed time-to-second-attack values with NA if there was no second attack recorded
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(Time_to_2n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup > 1 ~ Time_to_2n_attack
  ))

# Replace the imputed time-to-third-attack values with NA if there was no third attack recorded
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(Time_to_3n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup == 2 ~ NA,
    Number_severe_asthma_attacks_during_followup > 2 ~ Time_to_3n_attack
  ))

# Replace the imputed time-to-fourth-attack values with NA if there was no fourth attack recorded
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(Time_to_4n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup == 2 ~ NA,
    Number_severe_asthma_attacks_during_followup == 3 ~ NA,
    Number_severe_asthma_attacks_during_followup > 3 ~ Time_to_4n_attack
  ))

# Replace the imputed time-to-fifth-attack values with NA if there was no fifth attack recorded
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(Time_to_5n_attack = case_when(
    Number_severe_asthma_attacks_during_followup == 0 ~ NA,
    Number_severe_asthma_attacks_during_followup == 1 ~ NA,
    Number_severe_asthma_attacks_during_followup == 2 ~ NA,
    Number_severe_asthma_attacks_during_followup == 3 ~ NA,
    Number_severe_asthma_attacks_during_followup == 4 ~ NA,
    Number_severe_asthma_attacks_during_followup > 4 ~ Time_to_5n_attack
  ))

```

```{r, eval = FALSE}
# For dataset data_arm_age12.SIshort
# Complete the time-to-first-event variable with the maximum follow-up duration if no attack occurred during follow-up and save into new variable Time_1st_event_FU_max

data_arm_age12.SIshort$Follow_up_duration_days <- 
  as.numeric(data_arm_age12.SIshort$Follow_up_duration_days) # make sure the variable has the correct data type

data_arm_age12.SIshort <- data_arm_age12.SIshort %>%
  mutate(Time_1st_event_FU_max =
           case_when(
             Number_severe_asthma_attacks_during_followup == 0 ~ Follow_up_duration_days,
             Number_severe_asthma_attacks_during_followup > 0 ~ Time_to_First_attack
           ), .after = Time_to_5n_attack)
```

```{r, eval = FALSE}
# For dataset imp_data_ORACLE_final_COMP
# Complete the time-to-first-event variable with the maximum follow-up duration if no attack occurred during follow-up and save into new variable Time_1st_event_FU_max

imp_data_ORACLE_final_COMP$Follow_up_duration_days <- 
  as.numeric(imp_data_ORACLE_final_COMP$Follow_up_duration_days)

imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(Time_1st_event_FU_max =
           case_when(
             Number_severe_asthma_attacks_during_followup == 0 ~ Follow_up_duration_days,
             Number_severe_asthma_attacks_during_followup > 0 ~ Time_to_First_attack
           ), .after = Time_to_5n_attack)
```

```{r, eval = FALSE}
# For dataset imp_data_ORACLE_final_COMP_NR
# Complete the time-to-first-event variable with the maximum follow-up duration if no attack occurred during follow-up and save into new variable Time_1st_event_FU_max
imp_data_ORACLE_final_COMP_NR$Follow_up_duration_days <- 
  as.numeric(imp_data_ORACLE_final_COMP_NR$Follow_up_duration_days)

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(Time_1st_event_FU_max =
           case_when(
             Number_severe_asthma_attacks_during_followup == 0 ~ Follow_up_duration_days,
             Number_severe_asthma_attacks_during_followup > 0 ~ Time_to_First_attack
           ), .after = Time_to_5n_attack)
```

```{r, eval = FALSE}
# This part of the R code replaces the systematically missing values, that are imputed using multiple imputation, and puts the imputed values back to NA

# We need to find a numerical value that is not present in the dataset
which(data == 8888, arr.ind = TRUE) # This will return a matrix showing the row and column indices where 8888 is found

# Using the non-imputed, original data set data_arm_age12.SIshort, create separate datasets per trial and replace missing values with 8888 if the column was completely missing (100% NA)

# AZISAST
data_AZISAST <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "AZISAST")
replace_8888_AZI <- function(data_AZISAST) {
  for (col in colnames(data_AZISAST)) {
    if (all(is.na(data_AZISAST[[col]]))) {
      data_AZISAST[[col]] <- ifelse(is.na(data_AZISAST[[col]]), 8888, data_AZISAST[[col]])
    }
  }
  return(data_AZISAST)
}
data_AZISAST <- replace_8888_AZI(data_AZISAST)

# BENRAP2B
data_BENRAP2B <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "BENRAP2B")
replace_8888_BEN <- function(data_BENRAP2B) {
  for (col in colnames(data_BENRAP2B)) {
    if (all(is.na(data_BENRAP2B[[col]]))) {
      data_BENRAP2B[[col]] <- ifelse(is.na(data_BENRAP2B[[col]]), 8888, data_BENRAP2B[[col]])
    }
  }
  return(data_BENRAP2B)
}
data_BENRAP2B <- replace_8888_BEN(data_BENRAP2B)

# CAPTAIN
data_CAPTAIN <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "CAPTAIN")
replace_8888_CAP <- function(data_CAPTAIN) {
  for (col in colnames(data_CAPTAIN)) {
    if (all(is.na(data_CAPTAIN[[col]]))) {
      data_CAPTAIN[[col]] <- ifelse(is.na(data_CAPTAIN[[col]]), 8888, data_CAPTAIN[[col]])
    }
  }
  return(data_CAPTAIN)
}
data_CAPTAIN <- replace_8888_CAP(data_CAPTAIN)

# COSTA
data_COSTA <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "COSTA")
replace_8888_COS <- function(data_COSTA) {
  for (col in colnames(data_COSTA)) {
    if (all(is.na(data_COSTA[[col]]))) {
      data_COSTA[[col]] <- ifelse(is.na(data_COSTA[[col]]), 8888, data_COSTA[[col]])
    }
  }
  return(data_COSTA)
}
data_COSTA <- replace_8888_COS(data_COSTA)

# DREAM
data_DREAM <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "DREAM")
replace_8888_DRE <- function(data_DREAM) {
  for (col in colnames(data_DREAM)) {
    if (all(is.na(data_DREAM[[col]]))) {
      data_DREAM[[col]] <- ifelse(is.na(data_DREAM[[col]]), 8888, data_DREAM[[col]])
    }
  }
  return(data_DREAM)
}
data_DREAM <- replace_8888_DRE(data_DREAM)

# DRI12544
data_DRI12544 <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "DRI12544")
replace_8888_DRI <- function(data_DRI12544) {
  for (col in colnames(data_DRI12544)) {
    if (all(is.na(data_DRI12544[[col]]))) {
      data_DRI12544[[col]] <- ifelse(is.na(data_DRI12544[[col]]), 8888, data_DRI12544[[col]])
    }
  }
  return(data_DRI12544)
}
data_DRI12544 <- replace_8888_DRI(data_DRI12544)

# EXTRA
data_EXTRA <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "EXTRA")
replace_8888_EXT <- function(data_EXTRA) {
  for (col in colnames(data_EXTRA)) {
    if (all(is.na(data_EXTRA[[col]]))) {
      data_EXTRA[[col]] <- ifelse(is.na(data_EXTRA[[col]]), 8888, data_EXTRA[[col]])
    }
  }
  return(data_EXTRA)
}
data_EXTRA <- replace_8888_EXT(data_EXTRA)

# LAVOLTA 1
data_LAVOLTA1 <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "LAVOLTA_1")
replace_8888_LA1 <- function(data_LAVOLTA1) {
  for (col in colnames(data_LAVOLTA1)) {
    if (all(is.na(data_LAVOLTA1[[col]]))) {
      data_LAVOLTA1[[col]] <- ifelse(is.na(data_LAVOLTA1[[col]]), 8888, data_LAVOLTA1[[col]])
    }
  }
  return(data_LAVOLTA1)
}
data_LAVOLTA1 <- replace_8888_LA1(data_LAVOLTA1)

# LAVOLTA 2
data_LAVOLTA2 <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "LAVOLTA_2")
replace_8888_LA2 <- function(data_LAVOLTA2) {
  for (col in colnames(data_LAVOLTA2)) {
    if (all(is.na(data_LAVOLTA2[[col]]))) {
      data_LAVOLTA2[[col]] <- ifelse(is.na(data_LAVOLTA2[[col]]), 8888, data_LAVOLTA2[[col]])
    }
  }
  return(data_LAVOLTA2)
}
data_LAVOLTA2 <- replace_8888_LA2(data_LAVOLTA2)

# LUSTER 1
data_LUSTER1 <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "LUSTER_1")
replace_8888_LU1 <- function(data_LUSTER1) {
  for (col in colnames(data_LUSTER1)) {
    if (all(is.na(data_LUSTER1[[col]]))) {
      data_LUSTER1[[col]] <- ifelse(is.na(data_LUSTER1[[col]]), 8888, data_LUSTER1[[col]])
    }
  }
  return(data_LUSTER1)
}
data_LUSTER1 <- replace_8888_LU1(data_LUSTER1)

# LUSTER 2
data_LUSTER2 <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "LUSTER_2")
replace_8888_LU2 <- function(data_LUSTER2) {
  for (col in colnames(data_LUSTER2)) {
    if (all(is.na(data_LUSTER2[[col]]))) {
      data_LUSTER2[[col]] <- ifelse(is.na(data_LUSTER2[[col]]), 8888, data_LUSTER2[[col]])
    }
  }
  return(data_LUSTER2)
}
data_LUSTER2 <- replace_8888_LU2(data_LUSTER2)

# LUTE 
data_LUTE <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "LUTE")
replace_8888_LUT <- function(data_LUTE) {
  for (col in colnames(data_LUTE)) {
    if (all(is.na(data_LUTE[[col]]))) {
      data_LUTE[[col]] <- ifelse(is.na(data_LUTE[[col]]), 8888, data_LUTE[[col]])
    }
  }
  return(data_LUTE)
}
data_LUTE <- replace_8888_LUT(data_LUTE)

# MILLY
data_MILLY <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "MILLY")
replace_8888_MIL <- function(data_MILLY) {
  for (col in colnames(data_MILLY)) {
    if (all(is.na(data_MILLY[[col]]))) {
      data_MILLY[[col]] <- ifelse(is.na(data_MILLY[[col]]), 8888, data_MILLY[[col]])
    }
  }
  return(data_MILLY)
}
data_MILLY <- replace_8888_MIL(data_MILLY)

# NAVIGATOR
data_NAVIGATOR <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "NAVIGATOR")
replace_8888_NAV <- function(data_NAVIGATOR) {
  for (col in colnames(data_NAVIGATOR)) {
    if (all(is.na(data_NAVIGATOR[[col]]))) {
      data_NAVIGATOR[[col]] <- ifelse(is.na(data_NAVIGATOR[[col]]), 8888, data_NAVIGATOR[[col]])
    }
  }
  return(data_NAVIGATOR)
}
data_NAVIGATOR <- replace_8888_NAV(data_NAVIGATOR)

# Novel_START
data_Novel_START <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "Novel_START")
replace_8888_NOV <- function(data_Novel_START) {
  for (col in colnames(data_Novel_START)) {
    if (all(is.na(data_Novel_START[[col]]))) {
      data_Novel_START[[col]] <- ifelse(is.na(data_Novel_START[[col]]), 8888, data_Novel_START[[col]])
    }
  }
  return(data_Novel_START)
}
data_Novel_START <- replace_8888_NOV(data_Novel_START)

# PACT
data_PACT <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "PACT")
replace_8888_PAC <- function(data_PACT) {
  for (col in colnames(data_PACT)) {
    if (all(is.na(data_PACT[[col]]))) {
      data_PACT[[col]] <- ifelse(is.na(data_PACT[[col]]), 8888, data_PACT[[col]])
    }
  }
  return(data_PACT)
}
data_PACT <- replace_8888_PAC(data_PACT)

# PRACTICAL
data_PRACTICAL <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "PRACTICAL")
replace_8888_PRA <- function(data_PRACTICAL) {
  for (col in colnames(data_PRACTICAL)) {
    if (all(is.na(data_PRACTICAL[[col]]))) {
      data_PRACTICAL[[col]] <- ifelse(is.na(data_PRACTICAL[[col]]), 8888, data_PRACTICAL[[col]])
    }
  }
  return(data_PRACTICAL)
}
data_PRACTICAL <- replace_8888_PRA(data_PRACTICAL)

# PATHWAY
data_PATHWAY <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "PATHWAY")
replace_8888_PAT <- function(data_PATHWAY) {
  for (col in colnames(data_PATHWAY)) {
    if (all(is.na(data_PATHWAY[[col]]))) {
      data_PATHWAY[[col]] <- ifelse(is.na(data_PATHWAY[[col]]), 8888, data_PATHWAY[[col]])
    }
  }
  return(data_PATHWAY)
}
data_PATHWAY <- replace_8888_PAT(data_PATHWAY)

# QUEST
data_QUEST <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "QUEST")
replace_8888_QUE <- function(data_QUEST) {
  for (col in colnames(data_QUEST)) {
    if (all(is.na(data_QUEST[[col]]))) {
      data_QUEST[[col]] <- ifelse(is.na(data_QUEST[[col]]), 8888, data_QUEST[[col]])
    }
  }
  return(data_QUEST)
}
data_QUEST <- replace_8888_QUE(data_QUEST)

# STRATOS 1
data_STRATOS1 <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "STRATOS_1")
replace_8888_ST1 <- function(data_STRATOS1) {
  for (col in colnames(data_STRATOS1)) {
    if (all(is.na(data_STRATOS1[[col]]))) {
      data_STRATOS1[[col]] <- ifelse(is.na(data_STRATOS1[[col]]), 8888, data_STRATOS1[[col]])
    }
  }
  return(data_STRATOS1)
}
data_STRATOS1 <- replace_8888_ST1(data_STRATOS1)

# STRATOS 2
data_STRATOS2 <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "STRATOS_2")
replace_8888_ST2 <- function(data_STRATOS2) {
  for (col in colnames(data_STRATOS2)) {
    if (all(is.na(data_STRATOS2[[col]]))) {
      data_STRATOS2[[col]] <- ifelse(is.na(data_STRATOS2[[col]]), 8888, data_STRATOS2[[col]])
    }
  }
  return(data_STRATOS2)
}
data_STRATOS2 <- replace_8888_ST2(data_STRATOS2)

# VERSE
data_VERSE <- data_arm_age12.SIshort %>% filter(Enrolled_Trial_name == "VERSE")
replace_8888_VER <- function(data_VERSE) {
  for (col in colnames(data_VERSE)) {
    if (all(is.na(data_VERSE[[col]]))) {
      data_VERSE[[col]] <- ifelse(is.na(data_VERSE[[col]]), 8888, data_VERSE[[col]])
    }
  }
  return(data_VERSE)
}
data_VERSE <- replace_8888_VER(data_VERSE)

```

```{r, eval = FALSE}
# Check variables and column numbers for one of the trial data sets 
## Completely missing variables should now have only 8888 as value

tibble(
  ColumnNumber = seq_along(data_VERSE),
  VariableName = names(data_VERSE)
  ) %>% print(n= 100)
```

```{r, eval = FALSE}
# Assign data types factor, numeric and character in every new data set

factors <- c(3,4,6,8:11,14,15,17:24,28,30:33,35:37)
data_AZISAST <- data_AZISAST %>% mutate(across(all_of(factors), as.factor))
data_BENRAP2B <- data_BENRAP2B %>% mutate(across(all_of(factors), as.factor))
data_CAPTAIN <- data_CAPTAIN %>% mutate(across(all_of(factors), as.factor))
data_COSTA <- data_COSTA %>% mutate(across(all_of(factors), as.factor))
data_DREAM <- data_DREAM %>% mutate(across(all_of(factors), as.factor))
data_DRI12544 <- data_DRI12544 %>% mutate(across(all_of(factors), as.factor))
data_EXTRA <- data_EXTRA %>% mutate(across(all_of(factors), as.factor))
data_LAVOLTA1 <- data_LAVOLTA1 %>% mutate(across(all_of(factors), as.factor))
data_LAVOLTA2 <- data_LAVOLTA2 %>% mutate(across(all_of(factors), as.factor))
data_LUSTER1 <- data_LUSTER1 %>% mutate(across(all_of(factors), as.factor))
data_LUSTER2 <- data_LUSTER2 %>% mutate(across(all_of(factors), as.factor))
data_LUTE <- data_LUTE %>% mutate(across(all_of(factors), as.factor))
data_MILLY <- data_MILLY %>% mutate(across(all_of(factors), as.factor))
data_NAVIGATOR <- data_NAVIGATOR %>% mutate(across(all_of(factors), as.factor))
data_Novel_START <- data_Novel_START %>% mutate(across(all_of(factors), as.factor))
data_PACT <- data_PACT %>% mutate(across(all_of(factors), as.factor))
data_PATHWAY <- data_PATHWAY %>% mutate(across(all_of(factors), as.factor))
data_PRACTICAL <- data_PRACTICAL %>% mutate(across(all_of(factors), as.factor))
data_QUEST <- data_QUEST %>% mutate(across(all_of(factors), as.factor))
data_STRATOS1 <- data_STRATOS1 %>% mutate(across(all_of(factors), as.factor))
data_STRATOS2 <- data_STRATOS2 %>% mutate(across(all_of(factors), as.factor))
data_VERSE <- data_VERSE %>% mutate(across(all_of(factors), as.factor))

characters <- 2
data_AZISAST <- data_AZISAST %>% mutate(across(all_of(characters), as.character))
data_BENRAP2B <- data_BENRAP2B %>% mutate(across(all_of(characters), as.character))
data_CAPTAIN <- data_CAPTAIN %>% mutate(across(all_of(characters), as.character))
data_COSTA <- data_COSTA %>% mutate(across(all_of(characters), as.character))
data_DREAM <- data_DREAM %>% mutate(across(all_of(characters), as.character))
data_DRI12544 <- data_DRI12544 %>% mutate(across(all_of(characters), as.character))
data_EXTRA <- data_EXTRA %>% mutate(across(all_of(characters), as.character))
data_LAVOLTA1 <- data_LAVOLTA1 %>% mutate(across(all_of(characters), as.character))
data_LAVOLTA2 <- data_LAVOLTA2 %>% mutate(across(all_of(characters), as.character))
data_LUSTER1 <- data_LUSTER1 %>% mutate(across(all_of(characters), as.character))
data_LUSTER2 <- data_LUSTER2 %>% mutate(across(all_of(characters), as.character))
data_LUTE <- data_LUTE %>% mutate(across(all_of(characters), as.character))
data_MILLY <- data_MILLY %>% mutate(across(all_of(characters), as.character))
data_NAVIGATOR <- data_NAVIGATOR %>% mutate(across(all_of(characters), as.character))
data_Novel_START <- data_Novel_START %>% mutate(across(all_of(characters), as.character))
data_PACT <- data_PACT %>% mutate(across(all_of(characters), as.character))
data_PATHWAY <- data_PATHWAY %>% mutate(across(all_of(characters), as.character))
data_PRACTICAL <- data_PRACTICAL %>% mutate(across(all_of(characters), as.character))
data_QUEST <- data_QUEST %>% mutate(across(all_of(characters), as.character))
data_STRATOS1 <- data_STRATOS1 %>% mutate(across(all_of(characters), as.character))
data_STRATOS2 <- data_STRATOS2 %>% mutate(across(all_of(characters), as.character))
data_VERSE <- data_VERSE %>% mutate(across(all_of(characters), as.character))

numeric <- c(1,5,7,12,16,25:27,29,34,38:56)
data_AZISAST <- data_AZISAST %>% mutate(across(all_of(numeric), as.numeric))
data_BENRAP2B <- data_BENRAP2B %>% mutate(across(all_of(numeric), as.numeric))
data_CAPTAIN <- data_CAPTAIN %>% mutate(across(all_of(numeric), as.numeric))
data_COSTA <- data_COSTA %>% mutate(across(all_of(numeric), as.numeric))
data_DREAM <- data_DREAM %>% mutate(across(all_of(numeric), as.numeric))
data_DRI12544 <- data_DRI12544 %>% mutate(across(all_of(numeric), as.numeric))
data_EXTRA <- data_EXTRA %>% mutate(across(all_of(numeric), as.numeric))
data_LAVOLTA1 <- data_LAVOLTA1 %>% mutate(across(all_of(numeric), as.numeric))
data_LAVOLTA2 <- data_LAVOLTA2 %>% mutate(across(all_of(numeric), as.numeric))
data_LUSTER1 <- data_LUSTER1 %>% mutate(across(all_of(numeric), as.numeric))
data_LUSTER2 <- data_LUSTER2 %>% mutate(across(all_of(numeric), as.numeric))
data_LUTE <- data_LUTE %>% mutate(across(all_of(numeric), as.numeric))
data_MILLY <- data_MILLY %>% mutate(across(all_of(numeric), as.numeric))
data_NAVIGATOR <- data_NAVIGATOR %>% mutate(across(all_of(numeric), as.numeric))
data_Novel_START <- data_Novel_START %>% mutate(across(all_of(numeric), as.numeric))
data_PACT <- data_PACT %>% mutate(across(all_of(numeric), as.numeric))
data_PATHWAY <- data_PATHWAY %>% mutate(across(all_of(numeric), as.numeric))
data_PRACTICAL <- data_PRACTICAL %>% mutate(across(all_of(numeric), as.numeric))
data_QUEST <- data_QUEST %>% mutate(across(all_of(numeric), as.numeric))
data_STRATOS1 <- data_STRATOS1 %>% mutate(across(all_of(numeric), as.numeric))
data_STRATOS2 <- data_STRATOS2 %>% mutate(across(all_of(numeric), as.numeric))
data_VERSE <- data_VERSE %>% mutate(across(all_of(numeric), as.numeric))
```

```{r, eval = FALSE}
# List all trials together in the correct order
data_list <- list(data_Novel_START, 
                  data_PRACTICAL, 
                  data_AZISAST, 
                  data_EXTRA, 
                  data_COSTA, 
                  data_PACT, 
                  data_LAVOLTA1, 
                  data_LAVOLTA2,
                  data_MILLY, 
                  data_LUTE, 
                  data_VERSE, 
                  data_STRATOS1, 
                  data_STRATOS2, 
                  data_BENRAP2B, 
                  data_DRI12544, 
                  data_QUEST, 
                  data_LUSTER1, 
                  data_LUSTER2, 
                  data_CAPTAIN, 
                  data_DREAM, 
                  data_PATHWAY, 
                  data_NAVIGATOR)

# Combine them into a single data set
data_arm_age12_8888 <- bind_rows(data_list)
```

```{r, eval = FALSE}
# Put the systematically missing values back to NA

for (i in 3:58) {  # Loop through columns 3 to 58
  i_8888 <- i - 2  # Corresponding column index in data_arm_age12_8888
  
  rows_to_replace <- data_arm_age12_8888[, i_8888] == 8888 | data_arm_age12_8888[, i_8888] == "8888"
  seq_numbers_to_replace <- data_arm_age12_8888[rows_to_replace, "Sequential_number"]
  
  imp_data_ORACLE_final_COMP[imp_data_ORACLE_final_COMP$Sequential_number %in% seq_numbers_to_replace, i] <- NA
}

```

```{r, eval = FALSE}
# Assign the correct data type to all variables

factors <- c(5,6,8,10:13,16,17,19:26,30,32:35,37:39)
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>% mutate(across(all_of(factors), as.factor))

characters <- 4
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>% mutate(across(all_of(characters), as.character))

numeric <- c(3,7,9,14,18,27:29,31,36,40:58)
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>% mutate(across(all_of(numeric), as.numeric))
```


```{r, eval = FALSE}
# Add a variable for the calculated FEV1/FVC ratio for analyses later
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(FEV1_FVC_ratio =
           (FEV1_preBD_L_Baseline / FVC_preBD_L_Baseline)*100, .after = FEV1_PCT_reversibility_postBD)

summary(imp_data_ORACLE_final_COMP$FEV1_preBD_L_Baseline) # check the new variable

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(FEV1_FVC_ratio =
           (FEV1_preBD_L_Baseline / FVC_preBD_L_Baseline)*100, .after = FEV1_PCT_reversibility_postBD)

summary(imp_data_ORACLE_final_COMP_NR$FEV1_preBD_L_Baseline) # check the new variable
```


```{r, eval = FALSE}
# Write and save as CSV file
write.csv(imp_data_ORACLE_final_COMP, 'Network/:File.csv', row.names = FALSE)
```

```{r, eval = FALSE}
# Write and save as CSV file
write.csv(imp_data_ORACLE_final_COMP_NR, 'Network/:File.csv', row.names = FALSE)
```

```{r, eval = FALSE}
# Read CSV file
imp_data_ORACLE_final_COMP <- read.csv('I:/Fleur/6. ORACLE/1. Data/ORACLE_testdata/imp_data_ORACLE_final_COMP_20240918.csv')
```

```{r, eval = FALSE}
# Read CSV file
imp_data_ORACLE_final_COMP_NR <- read.csv('I:/Fleur/6. ORACLE/1. Data/ORACLE_testdata/imp_data_ORACLE_final_COMP_NR_20240918.csv')
```

```{r, eval = FALSE}
# Check variables and column numbers for the newly completed dataset

tibble(
  ColumnNumber = seq_along(imp_data_ORACLE_final_COMP),
  VariableName = names(imp_data_ORACLE_final_COMP)
  ) %>% print(n= 100)
```

```{r}
# Make sure all variables have the correct class assigned

factors <- c(5,6,8,10:13,16,17,19:26,30,32:35,37:39)
characters <- 4
numeric <- c(1:3,7,9,14,15,18,27:29,31,36,40:59)

imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>% mutate(across(all_of(factors), as.factor))
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>% mutate(across(all_of(factors), as.factor))

imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>% mutate(across(all_of(characters), as.character))
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>% mutate(across(all_of(characters), as.character))

imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>% mutate(across(all_of(numeric), as.numeric))
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>% mutate(across(all_of(numeric), as.numeric))
```


# Membership model (c-statistic)

```{r, eval = FALSE}
# Membership model

## Take one imputed data set from the completed data set 
subset_mm <- subset(imp_data_ORACLE_final_COMP, .imp == 1)

## Create dummy variable per trial, and a dummy for the smallest 4 trials combined
subset_mm <- within(subset_mm, {
  AZISAST <- ifelse(Enrolled_Trial_name == "AZISAST", 1, 0)
  BENRAP2B <- ifelse(Enrolled_Trial_name == "BENRAP2B", 1, 0)
  CAPTAIN <- ifelse(Enrolled_Trial_name == "CAPTAIN", 1, 0)
  COSTA <- ifelse(Enrolled_Trial_name == "COSTA", 1, 0)
  DREAM <- ifelse(Enrolled_Trial_name == "DREAM", 1, 0)
  DRI12544 <- ifelse(Enrolled_Trial_name == "DRI12544", 1, 0)
  EXTRA <- ifelse(Enrolled_Trial_name == "EXTRA", 1, 0)
  LAVOLTA_1 <- ifelse(Enrolled_Trial_name == "LAVOLTA_1", 1, 0)
  LAVOLTA_2 <- ifelse(Enrolled_Trial_name == "LAVOLTA_2", 1, 0)
  LUSTER_1 <- ifelse(Enrolled_Trial_name == "LUSTER_1", 1, 0)
  LUSTER_2 <- ifelse(Enrolled_Trial_name == "LUSTER_2", 1, 0)
  LUTE <- ifelse(Enrolled_Trial_name == "LUTE", 1, 0)
  MILLY <- ifelse(Enrolled_Trial_name == "MILLY", 1, 0)
  NAVIGATOR <- ifelse(Enrolled_Trial_name == "NAVIGATOR", 1, 0)
  Novel_START <- ifelse(Enrolled_Trial_name == "Novel_START", 1, 0)
  PACT <- ifelse(Enrolled_Trial_name == "PACT", 1, 0)
  PATHWAY <- ifelse(Enrolled_Trial_name == "PATHWAY", 1, 0)
  PRACTICAL <- ifelse(Enrolled_Trial_name == "PRACTICAL", 1, 0)
  QUEST <- ifelse(Enrolled_Trial_name == "QUEST", 1, 0)
  STRATOS_1 <- ifelse(Enrolled_Trial_name == "STRATOS_1", 1, 0)
  STRATOS_2 <- ifelse(Enrolled_Trial_name == "STRATOS_2", 1, 0)
  VERSE <- ifelse(Enrolled_Trial_name == "VERSE", 1, 0)
  COMBINED <- ifelse(Enrolled_Trial_name %in% c("AZISAST","LUTE","PACT","VERSE"), 1, 0)

})

```

```{r, eval = FALSE}
# Fit a logistic model with the dummy variable as dependent and the main variables as independent 

# Small trials combined
model_mm <- lrm(COMBINED ~ 
                  Any_severe_attack_previous_12m_0no_1yes + 
                  FEV1_preBD_PCT_Baseline + 
                  ACQ_baseline_score_mean + 
                  Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                  FeNO_baseline_ppb, 
                data = subset_mm)

model_mm
```

```{r, eval = FALSE}
# Trial 1: AZISAST
model_AZI <- update(model_mm, AZISAST ~ .)

model_AZI
```

```{r, eval = FALSE}
# Trial 2: BENRAP2B
model_BEN <- update(model_mm, BENRAP2B ~ .)

model_BEN
``` 

```{r, eval = FALSE}
# Trial 3: CAPTAIN
model_CAP <-  update(model_mm, CAPTAIN ~ .)

model_CAP
```

```{r, eval = FALSE}
# Trial 4: COSTA
model_COS <-  update(model_mm, COSTA ~ .)

model_CO

```

```{r, eval = FALSE}
# Trial 5: DREAM
model_DREAM <-  update(model_mm, DREAM ~ .)

model_DREAM
```

```{r, eval = FALSE}
# Trial 6: DRI12544
model_DRI <- update(model_mm, DRI12544 ~ .)

model_DRI
```

```{r, eval = FALSE}
# Trial 7: EXTRA
# No ACQ information available

model_EXTRA <- update(model_mm, EXTRA ~ . - ACQ_baseline_score_mean)

model_EXTRA
```

```{r, eval = FALSE}
# Trial 8: LAVOLTA_1
model_LAV1 <- update(model_mm, LAVOLTA_1 ~ .)

model_LAV1
```

```{r, eval = FALSE}
# Trial 9: LAVOLTA_2
model_LAV2 <- update(model_mm, LAVOLTA_2 ~ .)

model_LAV2
```

```{r, eval = FALSE}
# Trial 10: LUSTER_1
model_LUSTER1 <- update(model_mm, LUSTER_1 ~ .)

model_LUSTER1
```

```{r, eval = FALSE}
# Trial 11: LUSTER_2
model_LUSTER2 <- update(model_mm, LUSTER_2 ~ .)

model_LUSTER2
```

```{r, eval = FALSE}
# Trial 12: LUTE
model_LUTE <- update(model_mm, LUTE ~ .)

model_LUTE
```

```{r, eval = FALSE}
# Trial 13: MILLY
model_MILLY <- update(model_mm, MILLY ~ .)

model_MILLY
```

```{r, eval = FALSE}
# Trial 14: NAVIGATOR
## Any_attack = always 1
model_NAVI <- update(model_mm, NAVIGATOR ~ . - Any_severe_attack_previous_12m_0no_1yes)

model_NAVI
```

```{r, eval = FALSE}
# Trial 15: Novel_START
## No FEV1% information available
model_Novel <- update(model_mm, Novel_START ~ . - FEV1_preBD_PCT_Baseline)

model_Novel
```

```{r, eval = FALSE}
# Trial 16: PACT
## No attack history and ACQ information available
model_PACT <- update(model_mm, PACT ~ . - Any_severe_attack_previous_12m_0no_1yes - ACQ_baseline_score_mean)

model_PACT
```

```{r, eval = FALSE}
# Trial 17: PATHWAY
model_PATH <- update(model_mm, PATHWAY ~ .)

model_PATH
```

```{r, eval = FALSE}
# Trial 18: PRACTICAL
## No FEV1% information available
model_PRAC <- update(model_mm, PRACTICAL ~ . - FEV1_preBD_PCT_Baseline)
```

```{r, eval = FALSE}
# Trial 19: QUEST
## No attack history information available
model_QUEST <- update(model_mm, QUEST ~ . - Any_severe_attack_previous_12m_0no_1yes)
```

```{r, eval = FALSE}
# Trial 20: STRATOS_1
model_STRATOS1 <- update(model_mm, STRATOS_1 ~ .)

model_STRATOS1
```

```{r, eval = FALSE}
# Trial 21: STRATOS_2
model_STRATOS2 <- update(model_mm, STRATOS_2 ~ .)

model_STRATOS2
```

```{r, eval = FALSE}
# Trial 22: VERSE
model_VERSE <- update(model_mm, VERSE ~ .)

model_VERSE
```


# Scaling 25-75th percentile biomarkers (method prof. Frank Harrell)

```{r, eval = FALSE}
# Calculate and display the quantiles (25th and 75th percentiles) for the FeNO variable
quantile(imp_data_ORACLE_final_COMP$FeNO)     # Display quantiles for FeNO in the first dataset
quantile(imp_data_ORACLE_final_COMP_NR$FeNO)  # Display quantiles for FeNO in the second dataset

```

```{r, eval = FALSE}
# Scaling FeNO based on the 25th and 75th percentiles (method by Prof. Frank Harrell)
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(FeNO_p = FeNO / 28)  # Scale FeNO by dividing by 28 (between the 25th and 75th percentiles)

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(FeNO_p = FeNO / 28)  # Same scaling for the second dataset

```

```{r, eval = FALSE}
# Calculate and display the quantiles (25th and 75th percentiles) for the BEC variable
quantile(imp_data_ORACLE_final_COMP$BEC)  # Display quantiles for BEC in the first dataset
quantile(imp_data_ORACLE_final_COMP_NR$BEC)  # Display quantiles for BEC in the second dataset

```

```{r, eval = FALSE}
# Scaling BEC based on the 25th and 75th percentiles (method by Prof. Frank Harrell)
imp_data_ORACLE_final_COMP <- imp_data_ORACLE_final_COMP %>%
  mutate(BEC_p = BEC / 0.28)  # Scale BEC by dividing by 0.28 (between the 25th and 75th percentiles)

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(BEC_p = BEC / 0.28)  # Same scaling for the second dataset

```

# Negative binomial model: univariable

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Age as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Age + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Sex as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Gender_0Female_1Male + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BMI as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ BMI + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and GINA treatment step as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Treatment_step + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Attack history as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Any_severe_attack_previous_12m_0no_1yes + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of severe attacks in the prevu=ious 12 months as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Number_severe_attack_previous_12m_con + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of hospitalisations in the past 12 months as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Number_hospitalisations_for_asthma_previous_12_months_con + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Smoking behaviour as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Smoking_0never_1ex_2current + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Pack years as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Pack_years + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Atopy history as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Atopy_history_0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergic Rhinitis as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ AllergicRhinitis__0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergy sensitisation as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Chronic Rhinosinusitis as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Chronic_Rhinosinusitis_0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Nasal polyposis as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Nasal_polyposis_0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Adherence in Trial as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Adherence_InTrial_quantity + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% pre-bronchodilator as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_preBD_PCT_Baseline + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% post-bronchodilator as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_postBD_PCT_Baseline + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% reversibility as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_PCT_reversibility_postBD + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1/FVC ratio as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_FVC_ratio + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and ACQ-5 symptom score as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ ACQ_baseline_score_mean + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BEC as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FeNO as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FeNO_baseline_ppb + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Total IgE as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Total_IgE + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_COMP, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



# Negative binomial model: multivariable adjusted for core clinical set

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Age as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Age + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit)) # pool the estimates following Rubin's rools
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3])))) # include exponent of the estimate as the rate ratio and the 95% CI of the rate ratio
colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Sex as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Gender_0Female_1Male + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BMI as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         BMI + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and GINA treatment step as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Treatment_step + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Attack history as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         ACQ_baseline_score_mean + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of severe asthma attacks in the previous 12 months as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Number_severe_attack_previous_12m_con + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of hospitalisations in the previous 12 months as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Number_hospitalisations_for_asthma_previous_12_months_con + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Smoking behaviour as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Smoking_0never_1ex_2current + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Pack years as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Pack_years + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergic Rhinitis as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         AllergicRhinitis__0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Atopy history as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Atopy_history_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergen sensitisation as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Chronic Rhinosinusitis as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Chronic_Rhinosinusitis_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Nasal polyposis as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Nasal_polyposis_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Adherence in Trial as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Adherence_InTrial_quantity + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% pre-bronchodilator as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FEV1_preBD_PCT_Baseline + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% reversibility as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FEV1_PCT_reversibility_postBD + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR


```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1/FVC ratio as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.
# Because the FEV1/FVC ratio was calculated after imputation, we cannot use the with() command here. Instead, we use the forloop as described in the univariable analyses
## Note: with() can be used here if the complete() command included "inc=TRUE" and was saved as a mids object

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                              FEV1_FVC_ratio + 
                              ACQ_baseline_score_mean + 
                              Any_severe_attack_previous_12m_0no_1yes + 
                              Treatment_step + 
                              offset(Follow_up_duration_days) + 
                              as.factor(Enrolled_Trial_name), 
                            data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and ACQ-5 symptom score as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BEC as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FeNO as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FeNO_baseline_ppb + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Total IgE as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Total_IgE + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


# Negative binomial model: multivariable adjusted for core clinical set + biomarkers

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Age as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Age + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit)) # pool the estimates following the Rubin's rules
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3])))) # include exponent of the estimate as the rate ratio and the 95% CI of the rate ratio

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Sex as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Gender_0Female_1Male + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes +
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BMI as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         BMI + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and GINA treatment step as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Treatment_step + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Attack history as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         ACQ_baseline_score_mean + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of severe asthma attacks in the previous 12 months as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Number_severe_attack_previous_12m_con + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of hospitalisation in the previous 12 months as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Number_hospitalisations_for_asthma_previous_12_months_con + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Smoking behaviour as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Smoking_0never_1ex_2current + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Pack years as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Pack_years + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergic Rhinitis as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         AllergicRhinitis__0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Atopy history as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Atopy_history_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergen sensitisation as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Chronic Rhinosinusitis as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Chronic_Rhinosinusitis_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Nasal polyposis as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Nasal_polyposis_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Adherence in trial as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Adherence_InTrial_quantity + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% pre-bronchodilator as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FEV1_preBD_PCT_Baseline + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% reversibility as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FEV1_PCT_reversibility_postBD + 
                         ACQ_baseline_score_mean +  
                         Any_severe_attack_previous_12m_0no_1yes + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1/FVC ratio as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                              FEV1_FVC_ratio + 
                              ACQ_baseline_score_mean + 
                              Any_severe_attack_previous_12m_0no_1yes + 
                              Treatment_step + 
                              FeNO_baseline_ppb + 
                              Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                              offset(Follow_up_duration_days) + 
                              as.factor(Enrolled_Trial_name), 
                            data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and ACQ-5 symptom score as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BEC as independent variable, adjusted for the core clinical set, biomarker FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step +
                         FeNO_baseline_ppb + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FeNO as independent variable, adjusted for the core clinical set, biomarker BEC, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FeNO_baseline_ppb + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Total IgE as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final_20240416, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Total_IgE + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


# Negative binomial model: multivariable adjusted for core clinical set (25-75th percentile scaling)

```{r, eval = FALSE}
# Use the 25-75th percentile scaled variable for FeNO and BEC in a negative binomial model

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_p + # FeNO scaled with 25-75th percentile
                Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                FEV1_preBD_PCT_Baseline + 
                Treatment_step + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                BEC_p + # BEC scaled with 25-75th percentile
                FeNO_baseline_ppb + 
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                FEV1_preBD_PCT_Baseline + 
                Treatment_step + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```

# Forest plots (forester package; ERS abstract 2024)

```{r, eval = FALSE}
# The forest plots were created using the forester package from Github
## This code was used for all forest plots, using different predefined sheets in the read_excel() funtion
## The forest plots were used for the ERS abstracts 2024, Vienna

devtools::install_github("rdboyes/forester")
library(forester)
```

```{r, eval = FALSE}
data <- suppressWarnings(read_excel("file.xlsx", sheet = "sheet")) # read the file in R
```

```{r, eval = FALSE}
# Create two data frames, one with the main variables and one with the other variables, for the forest plots

data_ORACLE_main <- data[c(4:8,20,22:24),]
data_ORACLE_other <- data[c(1:3,9:19,21,25),]
```

```{r, eval = FALSE}
# Plot the forest plot for the main variables

forester(
  left_side_data = data_ORACLE_main[,1],
  estimate = data_ORACLE_main$mean, # give column name used in sheet for RR
  ci_low = data_ORACLE_main$lower, # give column name used in sheet for lower bound 95% CI
  ci_high = data_ORACLE_main$upper, # give column name used in sheet for upper bound 95% CI
  estimate_precision = 2, # precision of the estimate, 2 decimals
  estimate_col_name = "Estimate (95% CI)", # column name for the estimate
  x_scale_linear = FALSE, # scale type, log
  xlim = c(0.03,10), # x axis limits
  xbreaks = c(0.03, 0.1, 0.3, 1, 3, 10), # x axis breaks
  ggplot_width = 35, # width of plot
  display = TRUE, # display PNG file directly after creating plot
  file_path = here::here("Network:/file.png"), # save the plot to files
  font_family = "Fira Sans", # font used for the plot
  null_line_at = 1 # line at x=1
)

```

```{r, eval = FALSE}
# Plot the forest plot for the other variables

forester(
  left_side_data = data_ORACLE_other[,1],
  estimate = data_ORACLE_other$mean,
  ci_low = data_ORACLE_other$lower,
  ci_high = data_ORACLE_other$upper,
  estimate_precision = 2,
  estimate_col_name = "Estimate (95% CI)",
  x_scale_linear = FALSE,
  xlim = c(0.03,10),
  xbreaks = c(0.03, 0.1, 0.3, 1, 3, 10),
  ggplot_width = 35,
  display = TRUE,
  file_path = here::here("Network:/file.png"),
  font_family = "Fira Sans",
  null_line_at = 1
)

```


# Figure 2 & S9: Forest plots (forestploter package; manuscript submission Oct 2024)

```{r, eval = FALSE}
# The forest plots were created using the forestploter package from Github
install.packages("devtools")
devtools::install_github("adayim/forestploter")
library(forestploter)
```

```{r, eval = FALSE}
# Load the data from Excel
## You can also save the results from the negative binomial models in a dataframe in R and use the dataframe here to make the forest plot. Using only R gives more transparency and is therefore preferred.

data_uni <- suppressWarnings(read_excel("20240919 Negative binomial models m=10.xlsx", sheet = "All"))
data_uni <- data_uni[c(25,26,8,4:7,21,24,23,1:3,9:20,22,27),]
```


```{r, eval = FALSE}
# Define the theme of the forest plot
tm <- forest_theme(base_size = 10,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_gp = gpar(col = "black", cex = 0.8),
                   ci_lwd = 1.6)

# Add a blank column for the forest plot to display CI
# Adjust the column width with space
data_uni$` ` <- paste(rep(" ", 40), collapse = " ")  # empty column

data_uni$se_uni <- (log(data_uni$upper_uni) - log(data_uni$mean_uni))/1.96
data_uni$se_multi <- (log(data_uni$upper_multi) - log(data_uni$mean_multi))/1.96

# Create confidence interval column to display
data_uni$`Rate ratio (95% CI) model 1` <- ifelse(is.na(data_uni$se_uni), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     data_uni$mean_uni, data_uni$lower_uni, data_uni$upper_uni))

# Create confidence interval column to display
data_uni$`Rate ratio (95% CI) model 2` <- ifelse(is.na(data_uni$se_multi), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     data_uni$mean_multi, data_uni$lower_multi, data_uni$upper_multi))

# Make the forest plot

# Basic plot
p <-
  forest(data_uni[,c(1,8,11,8,12)],
         est = list(data_uni$mean_uni, data_uni$mean_multi),
         lower = list(data_uni$lower_uni, data_uni$lower_multi),
         upper = list(data_uni$upper_uni, data_uni$upper_multi),
         sizes = 0.7,
         ci_column = c(2,4),
         ref_line = 1,
         xlim = c(0.03, 3),
         ticks_digits = 2,
         ticks_at = c(0.03, 0.1, 0.3, 1, 3),
         x_trans = "log10",
         footnote = "\n\n* Dichotomous variable (yes/no)\n** Per 10-fold increase",
         arrow_lab = c("Lower risk", "Higher risk"),
         theme = tm
         )

# Create a placeholder string
placeholder <- paste(rep(" ", 103), collapse = "")  # Adjust the number of spaces
placeholder2 <- paste(rep(" ", 87), collapse = "")  # Adjust the number of spaces

# Combine with the original texts
combined_text <- paste("Main variables", placeholder, "Univariable", placeholder2, "Multivariable")

# Edit plot using borders and text
g <- add_border(p, part = "header", row = 1, where = "top")
g <- add_border(g, part = "header", row = 1, where = "bottom")
g <- insert_text(g,
                 text = combined_text,
                 row = 1,
                 just = "left",
                 gp = gpar(cex = 1, col = "darkblue", fontface = "bold.italic"))
g <- insert_text(g,
                 text = "\nOther variables explored",
                 row = 11,
                 just = "left",
                 gp = gpar(cex = 1, col = "darkblue", fontface = "bold.italic"))

# Save the plot to files
pdf(file = "20241009 Forest Plot New Version with forestploter v2.pdf", width = 15, height = 10)
plot(g)
dev.off()
```


```{r, eval = FALSE}
# We created another forest plot using the 25-75th percentile scaling method described by prof. Frank Harrell
data_perc <- suppressWarnings(read_excel("20241004 Negative binomial models m=10 standardized 25-75 percentile.xlsx", sheet = "All"))
data_perc <- data_perc[c(25,26,4:8,21,24,23,1:3,9:20,22,27),]
```

```{r, eval = FALSE}
# Define theme
tm <- forest_theme(base_size = 10,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_gp = gpar(col = "black", cex = 0.8),
                   ci_lwd = 1.6)

# Add a blank column for the forest plot to display CI.
# Adjust the column width with space.
data_perc$` ` <- paste(rep(" ", 40), collapse = " ")  # empty column

data_perc$se <- (log(data_perc$upper_multi) - log(data_perc$mean_multi))/1.96


# Create confidence interval column to display
data_perc$`Rate ratio (95% CI) model 2` <- ifelse(is.na(data_perc$se), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     data_perc$mean_multi, data_perc$lower_multi, data_perc$upper_multi))

# Make the plot

p <-
  forest(data_perc[,c(1,8,10)],
         est = data_perc$mean_multi,
         lower = data_perc$lower_multi,
         upper = data_perc$upper_multi,
         sizes = 0.5,
         ci_column = 2,
         ref_line = 1,
         xlim = c(0.03, 3),
         ticks_digits = 2,
         ticks_at = c(0.03, 0.1, 0.3, 1, 3),
         x_trans = "log10",
         footnote = "\n* Dichotomous variable (yes/no)",
         arrow_lab = c("Lower risk", "Higher risk"),
         theme = tm
         )

# Create a placeholder string
placeholder <- paste(rep(" ", 100), collapse = "")  # Adjust the number of spaces

# Combine with the original texts
combined_text <- paste("Main variables", placeholder, "Multivariable")

g <- add_border(p, part = "header", row = 1, where = "top")
g <- add_border(g, part = "header", row = 1, where = "bottom")
g <- insert_text(g,
                 text = combined_text,
                 row = 1,
                 just = "left",
                 gp = gpar(cex = 1, col = "darkblue", fontface = "bold.italic"))
g <- insert_text(g,
                 text = "\nOther variables explored",
                 row = 11,
                 just = "left",
                 gp = gpar(cex = 1, col = "darkblue", fontface = "bold.italic"))

# Save the plot to files
pdf(file = "20241004 Forest Plot PERCENTILES New Version with forestploter v2.pdf", width = 15, height = 10)
plot(g)
dev.off()
```


```{r, eval = FALSE}
# A third forst plot was created using the same percentile scaling method, but displaying only the biomarkers BEC and FeNO

# Make a smaller dataset
data_perc_bm <- data_perc[c(1,2),]

# Make the plot
p <-
  forest(data_perc_bm[,c(1,8,10)],
         est = data_perc_bm$mean_multi,
         lower = data_perc_bm$lower_multi,
         upper = data_perc_bm$upper_multi,
         sizes = 0.5,
         ci_column = 2,
         ref_line = 1,
         xlim = c(0.03, 3),
         ticks_digits = 2,
         ticks_at = c(0.03, 0.1, 0.3, 1, 3),
         x_trans = "log10",
         #footnote = "\n* Dichotomous variable (yes/no)",
         arrow_lab = c("Lower risk", "Higher risk"),
         theme = tm
         )

# Create a placeholder string
placeholder <- paste(rep(" ", 90), collapse = "")  # Adjust the number of spaces

# Combine with the original texts
combined_text <- paste("Biomarkers", placeholder, "Multivariable")

g <- add_border(p, part = "header", row = 1, where = "top")
g <- add_border(g, part = "header", row = 1, where = "bottom")
g <- insert_text(g,
                 text = combined_text,
                 row = 1,
                 just = "left",
                 gp = gpar(cex = 1, col = "darkblue", fontface = "bold.italic"))

# Save the plot to files
pdf(file = "20241007 Forest Plot PERCENTILES ONLY BM New Version with forestploter v5.pdf", width = 15, height = 10)
plot(g)
dev.off()
```


# Negative binomial model: R squared

```{r, eval = FALSE}
# Calculate the mean R squared for every variable that was used in the negative binomial model
# Age

model_R2 <- numeric(10) # Initialize vectors to store R-squared values for the models
null_model_R2 <- numeric(10)

for (i in 1:10){  # Loop through 10 data sets
  model <- glm.nb( # Fit a negative binomial model
    Number_severe_asthma_attacks_during_followup ~ Age +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Age) # Update the model to create a null model by removing 'Age' from the predictors
  
  model_R2[i] <- NagelkerkeR2(model)$R2  # Calculate the Nagelkerke R-squared for both models
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

# Calculate the mean R-squared values for the models
mean(model_R2)
mean(null_model_R2)
```



```{r, eval = FALSE}
# Sex

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Gender_0Female_1Male +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Gender_0Female_1Male)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```


```{r, eval = FALSE}
# BMI

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ BMI +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - BMI)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```

```{r, eval = FALSE}
# GINA treatment step

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Treatment_step +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Treatment_step)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```


```{r, eval = FALSE}
# Attack history

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Any_severe_attack_previous_12m_0no_1yes +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Any_severe_attack_previous_12m_0no_1yes)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```


```{r, eval = FALSE}
# Number of severe attacks in the previous 12 months

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Number_severe_attack_previous_12m_con +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Number_severe_attack_previous_12m_con)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```



```{r, eval = FALSE}
# Number of hospitalisations in the previous 12 months

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Number_hospitalisations_for_asthma_previous_12_months_con +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Number_hospitalisations_for_asthma_previous_12_months_con)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```


```{r, eval = FALSE}
# Smoking behaviour

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Smoking_0never_1ex_2current +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Smoking_0never_1ex_2current)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```



```{r, eval = FALSE}
# Pack years

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Pack_years +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Pack_years)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```

```{r, eval = FALSE}
# Allergic Rhinitis

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ AllergicRhinitis__0no_1yes_9999notknown +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - AllergicRhinitis__0no_1yes_9999notknown)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```


```{r, eval = FALSE}
# Atopy history

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Atopy_history_0no_1yes_9999notknown_COMPUTED +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Atopy_history_0no_1yes_9999notknown_COMPUTED)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)

```

```{r, eval = FALSE}
# Allergen sensitisation

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)

```

```{r, eval = FALSE}
# Chronic Rhinosinusitis

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Chronic_Rhinosinusitis_0no_1yes_9999notknown +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Chronic_Rhinosinusitis_0no_1yes_9999notknown)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```

```{r, eval = FALSE}
# Nasal polyposis

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Nasal_polyposis_0no_1yes_9999notknown +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Nasal_polyposis_0no_1yes_9999notknown)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```

```{r, eval = FALSE}
# Adherence in trial

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Adherence_InTrial_quantity +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Adherence_InTrial_quantity)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)

```

```{r, eval = FALSE}
# FEV1% pre-bronchodilator

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ FEV1_preBD_PCT_Baseline +
      ACQ_baseline_score_mean + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - FEV1_preBD_PCT_Baseline)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```

```{r, eval = FALSE}
# FEV1% reversibility

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ FEV1_PCT_reversibility_postBD +
      ACQ_baseline_score_mean + 
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - FEV1_PCT_reversibility_postBD)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```


```{r, eval = FALSE}
# ACQ-5 symptom score

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ ACQ_baseline_score_mean +
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - ACQ_baseline_score_mean)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)
```

```{r, eval = FALSE}
# BEC

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced +
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      FeNO_baseline_ppb + 
      ACQ_baseline_score_mean + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)

```

```{r, eval = FALSE}
# FeNO

model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ FeNO_baseline_ppb +
      FEV1_preBD_PCT_Baseline + 
      Treatment_step +
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      ACQ_baseline_score_mean + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - FeNO_baseline_ppb)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)

```

```{r, eval = FALSE}
# Total IgE
model_R2 <- numeric(10)
null_model_R2 <- numeric(10)

for (i in 1:10){ 
  model <- glm.nb(
    Number_severe_asthma_attacks_during_followup ~ Total_IgE  +
      FEV1_preBD_PCT_Baseline + 
      FeNO_baseline_ppb + 
      Treatment_step +
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
      ACQ_baseline_score_mean + 
      Any_severe_attack_previous_12m_0no_1yes + 
      offset(Follow_up_duration_days) + 
      as.factor(Enrolled_Trial_name), 
    data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
  
  null_model <- 
  update(model, . ~ . - Total_IgE)
  
  model_R2[i] <- NagelkerkeR2(model)$R2
  null_model_R2[i] <- NagelkerkeR2(null_model)$R2
} 

mean(model_R2)
mean(null_model_R2)

```


# Table S11 A & B: 3x3 BEC and FeNO matrices

```{r, eval = FALSE}
# Create a dummy variable per FeNO-BEC combination (low, mid, high)
## FeNO <25, BEC <0.15

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_low_Eos_low = ifelse(
      FeNO_baseline_ppb < log10(25) & # the variables are log-transformed in the data set
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced < log10(0.15),
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_low_Eos_low <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_low_Eos_low) # make sure that the new variable is a factor
```

```{r, eval = FALSE}
## FeNO <25, BEC 0.15-0.30

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_low_Eos_mid = ifelse(
      FeNO_baseline_ppb < log10(25) & 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced >= log10(0.15) & 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced < log10(0.30),
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_low_Eos_mid <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_low_Eos_mid)

```

```{r, eval = FALSE}
## FeNO <25, BEC >=0.30

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_low_Eos_high = ifelse(
      FeNO_baseline_ppb < log10(25) & 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced >= log10(0.30),
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_low_Eos_high <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_low_Eos_high)
```

```{r, eval = FALSE}
## FeNO 25-50, BEC <0.15

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_mid_Eos_low = ifelse(
      FeNO_baseline_ppb >= log10(25) & 
      FeNO_baseline_ppb < log10(50) &
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced < log10(0.15), 
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_mid_Eos_low <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_mid_Eos_low)
```

```{r, eval = FALSE}
## FeNO 25-50, BEC 0.15-0.30

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_mid_Eos_mid = ifelse(
      FeNO_baseline_ppb >= log10(25) & 
      FeNO_baseline_ppb < log10(50) &
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced >= log10(0.15) &
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced < log10(0.30), 
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_mid_Eos_mid <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_mid_Eos_mid)
```

```{r, eval = FALSE}
## FeNO 25-50, BEC >=0.30

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_mid_Eos_high = ifelse(
      FeNO_baseline_ppb >= log10(25) & 
      FeNO_baseline_ppb < log10(50) &
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced >= log10(0.30), 
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_mid_Eos_high <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_mid_Eos_high)
```

```{r, eval = FALSE}
## FeNO >=50, BEC <0.15

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_high_Eos_low = ifelse(
      FeNO_baseline_ppb >= log10(50) & 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced < log10(0.15), 
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_high_Eos_low <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_high_Eos_low)
```

```{r, eval = FALSE}
## FeNO >=50, BEC 0.15-0.30

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_high_Eos_mid = ifelse(
      FeNO_baseline_ppb >= log10(50) & 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced >= log10(0.15) &
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced < log10(0.30),
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_high_Eos_mid <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_high_Eos_mid)
```

```{r, eval = FALSE}
## FeNO >=50, BEC >0.30

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(
    FeNO_high_Eos_high = ifelse(
      FeNO_baseline_ppb >= log10(50) & 
      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced >= log10(0.30),
      1, 0
      )
    )

imp_data_ORACLE_final_COMP_NR$FeNO_high_Eos_high <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_high_Eos_high)
```

```{r, eval = FALSE}
# Fit a negative binomial model per imputed dataset with all the main predictors, except for the biomarkers BEC and FeNO and store the estimates in a list

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                FEV1_preBD_PCT_Baseline + 
                Treatment_step + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

```

```{r, eval = FALSE}
# Take the linear predictors from the negative binomial model fit above

linear_predictors_list <- list() # create a list

# Loop through each imputed dataset
for (i in 1:length(res_comb)) {
  # Extract the linear.predictors from the glm.nb model in the current dataset
  linear_predictors <- res_comb[[i]]$linear.predictors
  
  # Append the linear predictors to the list
  linear_predictors_list[[i]] <- linear_predictors
}

all_linear_predictors <- unlist(linear_predictors_list)

linear_predictors_df <- data.frame(linear_predictors = all_linear_predictors)

```

```{r, eval = FALSE}
# Check a subset of the original and resulting data

print(res_comb[[1]]$linear.predictors[1:5])
print(res_comb[[2]]$linear.predictors[1:5])
print(all_linear_predictors[1:5])
print(all_linear_predictors[6514:6518])
```

```{r, eval = FALSE}
# Merge the linear predictors with the original dataset

imp_data_ORACLE_final_COMP_NR <- cbind(imp_data_ORACLE_final_COMP_NR, linear_predictors_df)
```

```{r, eval = FALSE}
# Check if the merging went correctly; [1:5] in all_linear_predictors should be the same as in the new variable "linear_predictors" in the original dataset; the same goes for [6514:6518]

print(all_linear_predictors[1:5])
print(all_linear_predictors[6514:6518])
print(imp_data_ORACLE_final_COMP_NR$linear_predictors[1:5])
print(imp_data_ORACLE_final_COMP_NR$linear_predictors[6514:6518])
```

```{r, eval = FALSE}
# Now we fit a negative binomial model per FeNO-BEC dummy category, with the offset of the linear predictors

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_low_Eos_low + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates following the Rubin's rules
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_low_Eos_mid + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_low_Eos_high + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_mid_Eos_low + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_mid_Eos_mid + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_mid_Eos_high + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_high_Eos_low + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_high_Eos_mid + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_high_Eos_high + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
# Prevalences of FeNO-BEC groups in the dataset

nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_low_Eos_low == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_low_Eos_mid == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_low_Eos_high == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_mid_Eos_low == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_mid_Eos_mid == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_mid_Eos_high == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_high_Eos_low == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_high_Eos_mid == 1))
nrow(filter(imp_data_ORACLE_final_COMP_NR, FeNO_high_Eos_high == 1))
```

```{r, eval = FALSE}
# All other rate ratio's and prevalences for different FeNO cut-offs for Supplementary Table S11 are calculated in the same way, but with different FeNO-BEC dummy variables
```



# Table S11.C5: 2x2 BEC and FeNO matrix

```{r, eval = FALSE}
# Create a dummy variable for FeNO and BEC groups
imp_data_ORACLE_final_COMP_NR <-
  imp_data_ORACLE_final_COMP_NR %>%
  mutate(BEC = 10^Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced) # Reverse the log transformation
# You could also use log(25) and log(0.15) in the FeNO- and BEC cutoff variable instead of the transformation, as was done in "Table S11 A & B"

imp_data_ORACLE_final_COMP_NR <-
  imp_data_ORACLE_final_COMP_NR %>% 
  mutate(FeNO = 10^FeNO_baseline_ppb) # Reverse the log transformation

imp_data_ORACLE_final_COMP_NR <- # Create a new variable for the cutoff value of FeNO
  imp_data_ORACLE_final_COMP_NR %>%
  mutate(FeNO_25cutoff =
           case_when(FeNO < 25 ~ 0,
                     FeNO >= 25 ~ 1))

imp_data_ORACLE_final_COMP_NR <- # Create a new variable for the cutoff value of BEC
  imp_data_ORACLE_final_COMP_NR %>%
  mutate(BEC_15cutoff =
           case_when(BEC < 0.15 ~ 0,
                     BEC >= 0.15 ~ 1))

imp_data_ORACLE_final_COMP_NR$FeNO_25cutoff <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_25cutoff) # Make sure it is a factor variable
imp_data_ORACLE_final_COMP_NR$BEC_15cutoff <- as.factor(imp_data_ORACLE_final_COMP_NR$BEC_15cutoff)
```

```{r, eval = FALSE}
# Check the distribution of patients over the groups

# Create a table with temporary labels for FeNO and BEC
combination_table <- table(
  factor(imp_data_ORACLE_final_COMP_NR$FeNO_25cutoff, 
         levels = c(0, 1), 
         labels = c("<25", ">=25")),
  
  factor(imp_data_ORACLE_final_COMP_NR$BEC_15cutoff, 
         levels = c(0, 1), 
         labels = c("<0.15", ">=0.15"))
)

# Print the table with temporary labels
print(combination_table)
```


```{r, eval = FALSE}
# Fit a negative binomial model with the FeNO and BEC cut off variables for all ten imputed datasets and pool the estimates using Rubin's rules
# The reference group is FeNO < 25 & BEC < 0.15

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FeNO_25cutoff == 1 & BEC_15cutoff == 0) + # FeNo >= 25 & BEC < 0.15
                (FeNO_25cutoff == 1 & BEC_15cutoff == 1) + # FeNo >= 25 & BEC >= 0.15
                (FeNO_25cutoff == 0 & BEC_15cutoff == 1) + # FeNo < 25 & BEC >= 0.15
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                FEV1_preBD_PCT_Baseline + 
                Treatment_step + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```



# Table S11.C6

```{r, eval = FALSE}
# Reverse log transformation
# This step is only needed if the dummies were not created in "Table S11.C5" already

imp_data_ORACLE_final_COMP_NR <-
  imp_data_ORACLE_final_COMP_NR %>%
  mutate(BEC = 10^Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced) # Reverse the log transformation
# You could also use log(25) and log(0.15) in the FeNO- and BEC cutoff variable instead of the transformation, as was done in "Table S11 A & B"

imp_data_ORACLE_final_COMP_NR <-
  imp_data_ORACLE_final_COMP_NR %>%
  mutate(FeNO = 10^FeNO_baseline_ppb)
```

```{r, eval = FALSE}
# Create a dummy variable for FeNO and BEC groups
imp_data_ORACLE_final_COMP_NR <-
  imp_data_ORACLE_final_COMP_NR %>%
  mutate(FeNO_BEC_2x1 = 
           ifelse(BEC < 0.15 & FeNO < 25, 0, 1) # Only the reference group BEC <0.15 & FeNO < 25 has a value of 0
         )

imp_data_ORACLE_final_COMP_NR$FeNO_BEC_2x1 <- as.factor(imp_data_ORACLE_final_COMP_NR$FeNO_BEC_2x1) # Make sure it is a factor variable

```

```{r, eval = FALSE}
# Check the distribution in the data
table(imp_data_ORACLE_final_COMP_NR$FeNO_BEC_2x1)
```


```{r, eval = FALSE}
# Fit a negative binomial model with the FeNO and BEC cut off variable for all ten imputed datasets and pool the estimates using Rubin's rules
# The reference group is FeNO < 25 & BEC < 0.15

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_BEC_2x1 + 
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                FEV1_preBD_PCT_Baseline + 
                Treatment_step + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```


# Table S12: 3x3 FEV1% pre-post

```{r, eval = FALSE}
# Check the distribution of the FEV1_preBD_L_Baseline in the dataset

# Initialize a list to store the results
results <- list()

# Loop over each imputed dataset (with .imp values from 1 to 10)
for (i in 1:10) {
  # Filter the data for the current imputation
  imputed_data <- imp_data_ORACLE_final_COMP_NR %>% filter(.imp == i)
  
  # Calculate summary statistics for FEV1_preBD_L_Baseline
  stats <- imputed_data %>%
    summarise(
      mean = mean(FEV1_preBD_L_Baseline, na.rm = TRUE),
      min = min(FEV1_preBD_L_Baseline, na.rm = TRUE),
      max = max(FEV1_preBD_L_Baseline, na.rm = TRUE),
      sd = sd(FEV1_preBD_L_Baseline, na.rm = TRUE),
      n = n()
    )
  
  # Store the result in the list
  results[[paste0("Imputation_", i)]] <- stats
}

# Combine the results into a data frame for easy viewing
results_df <- bind_rows(results, .id = "Imputation")

# Print the results
print(results_df)

# Make a histogram
hist(imp_data_ORACLE_final_COMP_NR$FEV1_preBD_L_Baseline)
```

```{r, eval = FALSE}
# Check the distribution of the FEV1_postBD_L_Baseline in the dataset

# Initialize a list to store the results
results <- list()

# Loop over each imputed dataset (with .imp values from 1 to 10)
for (i in 1:10) {
  # Filter the data for the current imputation
  imputed_data <- imp_data_ORACLE_final_COMP_NR %>% filter(.imp == i)
  
  # Calculate summary statistics for FEV1_postBD_L_Baseline
  stats <- imputed_data %>%
    summarise(
      mean = mean(FEV1_postBD_L_Baseline, na.rm = TRUE),
      min = min(FEV1_postBD_L_Baseline, na.rm = TRUE),
      max = max(FEV1_postBD_L_Baseline, na.rm = TRUE),
      sd = sd(FEV1_postBD_L_Baseline, na.rm = TRUE),
      n = n()
    )
  
  # Store the result in the list
  results[[paste0("Imputation_", i)]] <- stats
}

# Combine the results into a data frame for easy viewing
results_df <- bind_rows(results, .id = "Imputation")

# Print the results
print(results_df)

# Make a histogram
hist(imp_data_ORACLE_final_COMP_NR$FEV1_postBD_L_Baseline)
```



```{r, eval = FALSE}
# Check the distribution of the FEV1_postBD_PCT_Baseline in the dataset

# Initialize a list to store the results
results <- list()

# Loop over each imputed dataset (with .imp values from 1 to 10)
for (i in 1:10) {
  # Filter the data for the current imputation
  imputed_data <- imp_data_ORACLE_final_COMP_NR %>% filter(.imp == i)
  
  # Calculate summary statistics for FEV1_postBD_PCT_Baseline
  stats <- imputed_data %>%
    summarise(
      mean = mean(FEV1_postBD_PCT_Baseline, na.rm = TRUE),
      min = min(FEV1_postBD_PCT_Baseline, na.rm = TRUE),
      max = max(FEV1_postBD_PCT_Baseline, na.rm = TRUE),
      sd = sd(FEV1_postBD_PCT_Baseline, na.rm = TRUE),
      n = n()
    )
  
  # Store the result in the list
  results[[paste0("Imputation_", i)]] <- stats
}

# Combine the results into a data frame for easy viewing
results_df <- bind_rows(results, .id = "Imputation")

# Print the results
print(results_df)

# Make a histogram
hist(imp_data_ORACLE_final_COMP_NR$FEV1_postBD_PCT_Baseline)
```

```{r, eval = FALSE}
# Check the distribution of the FEV1_preBD_PCT_Baseline in the dataset

# Initialize a list to store the results
results <- list()

# Loop over each imputed dataset (with .imp values from 1 to 10)
for (i in 1:10) {
  # Filter the data for the current imputation
  imputed_data <- imp_data_ORACLE_final_COMP_NR %>% filter(.imp == i)
  
  # Calculate summary statistics for FEV1_preBD_PCT_Baseline
  stats <- imputed_data %>%
    summarise(
      mean = mean(FEV1_preBD_PCT_Baseline, na.rm = TRUE),
      min = min(FEV1_preBD_PCT_Baseline, na.rm = TRUE),
      max = max(FEV1_preBD_PCT_Baseline, na.rm = TRUE),
      sd = sd(FEV1_preBD_PCT_Baseline, na.rm = TRUE),
      n = n()
    )
  
  # Store the result in the list
  results[[paste0("Imputation_", i)]] <- stats
}

# Combine the results into a data frame for easy viewing
results_df <- bind_rows(results, .id = "Imputation")

# Print the results
print(results_df)

# Make a histogram
hist(imp_data_ORACLE_final_COMP_NR$FEV1_preBD_PCT_Baseline)
```


```{r, eval = FALSE}
# Create dummy variable for the 3x3 Table: cut offs of 70 and 80 %

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(FEV1_preBD_PCT_Group7080 = case_when(
    FEV1_preBD_PCT_Baseline < 70 ~ 0,
    FEV1_preBD_PCT_Baseline >= 70 & FEV1_preBD_PCT_Baseline < 80 ~ 1,
    TRUE ~ 2
  ))

imp_data_ORACLE_final_COMP_NR %>%
  count(FEV1_preBD_PCT_Group7080) # Count the number of values per group

imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(FEV1_postBD_PCT_Group7080 = case_when(
    FEV1_postBD_PCT_Baseline < 70 ~ 0,
    FEV1_postBD_PCT_Baseline >= 70 & FEV1_postBD_PCT_Baseline < 80 ~ 1,
    TRUE ~ 2
  ))

imp_data_ORACLE_final_COMP_NR %>%
  count(FEV1_postBD_PCT_Group7080) # Count the number of values per group
```

```{r, eval = FALSE}
# Fit a negative binomial model per imputed dataset with all the main variables, except for FEV1 %, and store the estimates in a list

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                Treatment_step + 
                Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                FeNO_baseline_ppb + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}
```

```{r, eval = FALSE}
# Take the linear predictors from the negative binomial model fit above

linear_predictors_list <- list() # create a list

# Loop through each imputed dataset
for (i in 1:length(res_comb)) {
  # Extract the linear.predictors from the glm.nb model in the current dataset
  linear_predictors <- res_comb[[i]]$linear.predictors
  
  # Append the linear predictors to the list
  linear_predictors_list[[i]] <- linear_predictors
}

all_linear_predictors <- unlist(linear_predictors_list)

linear_predictors_df_fev1 <- data.frame(linear_predictors = all_linear_predictors)

```

```{r, eval = FALSE}
# Check a subset of the original and resulting data

print(res_comb[[1]]$linear.predictors[1:5])
print(res_comb[[2]]$linear.predictors[1:5])
print(all_linear_predictors[1:5])
print(all_linear_predictors[6514:6518])
```

```{r, eval = FALSE}
# Merge the linear predictors with the original dataset

imp_data_ORACLE_final_COMP_NR <- cbind(imp_data_ORACLE_final_COMP_NR, linear_predictors_df_fev1)
```

```{r, eval = FALSE}
# Check if the merging was correct; [1:5] in all_linear_predictors should be the same as in the new variable "linear_predictors" in the original dataset; the same goes for [6514:6518]

print(all_linear_predictors[1:5])
print(all_linear_predictors[6514:6518])
print(imp_data_ORACLE_final_COMP_NR$linear_predictors[1:5])
print(imp_data_ORACLE_final_COMP_NR$linear_predictors[6514:6518])
```


```{r, eval = FALSE}
# Check the number of patients per category of the 3x3 Table

# Create a table with temporary labels for FEV1_preBD_PCT_Group and FEV1_postBD_PCT_Group
combination_table_7080 <- table(
  factor(imp_data_ORACLE_final_COMP_NR$FEV1_preBD_PCT_Group7080, 
         levels = c(0, 1, 2), 
         labels = c("preBD PCT <70", "preBD PCT 70-79", "preBD PCT >=80")),
  
  factor(imp_data_ORACLE_final_COMP_NR$FEV1_postBD_PCT_Group7080, 
         levels = c(0, 1, 2), 
         labels = c("postBD PCT <70", "postBD PCT 70-79", "postBD PCT >=80"))
)

# Print the table with temporary labels
print(combination_table_7080)

```


```{r, eval = FALSE}
# Fit a negative binomial model in ten imputed datasets for every category of FEV1% with the offset of the linear predictiors, and pool the results using the Rubin's rules
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                              (FEV1_preBD_PCT_Group7080 == 0 & FEV1_postBD_PCT_Group7080 == 0) + 
                              offset(linear_predictors), 
                            data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 1 & FEV1_postBD_PCT_Group7080 == 0) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 2 & FEV1_postBD_PCT_Group7080 == 0) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 0 & FEV1_postBD_PCT_Group7080 == 1) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 1 & FEV1_postBD_PCT_Group7080 == 1) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 2 & FEV1_postBD_PCT_Group7080 == 1) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 0 & FEV1_postBD_PCT_Group7080 == 2) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 1 & FEV1_postBD_PCT_Group7080 == 2) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                (FEV1_preBD_PCT_Group7080 == 2 & FEV1_postBD_PCT_Group7080 == 2) + 
                offset(linear_predictors), 
              data = subset(imp_data_ORACLE_final_COMP_NR, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```

# Figure 3A & 3C: Spline curve BEC FeNO & Spline curve FEV1% reversibility

```{r, eval = FALSE}
# Add a variable of FeNO and BEC with the non-log-transformed values
# This step is only necessary if the variables BEC and FeNO have not been created yet in "Table S11.C5"

imp_data_ORACLE_final_COMP_NR$BEC <- 10^(imp_data_ORACLE_final_COMP_NR$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced)
imp_data_ORACLE_final_COMP_NR$FeNO <- 10^(imp_data_ORACLE_final_COMP_NR$FeNO_baseline_ppb)

imp_data_ORACLE_final_COMP$BEC <- 10^(imp_data_ORACLE_final_COMP$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced)
imp_data_ORACLE_final_COMP$FeNO <- 10^(imp_data_ORACLE_final_COMP$FeNO_baseline_ppb)
```

```{r, eval = FALSE}
# Calculate the mean FeNO of the 10 imputations per patient in the dataset
patient_mean_FeNO_NR <- imp_data_ORACLE_final_COMP_NR %>%
  dplyr::group_by(Sequential_number) %>%
  dplyr::summarize(mean_FeNO = mean(FeNO, na.rm = TRUE))
```

```{r, eval = FALSE}
# Calculate the mean BEC of the 10 imputations per patient in the dataset
patient_mean_BEC_NR <- imp_data_ORACLE_final_COMP_NR %>%
  dplyr::group_by(Sequential_number) %>%
  dplyr::summarize(mean_BEC = mean(BEC, na.rm = TRUE))
```

```{r, eval = FALSE}
# Calculate the mean FEV1 reversibility of the 10 imputations per patient in the dataset
patient_mean_REV_NR <- imp_data_ORACLE_final_COMP_NR %>%
  dplyr::group_by(Sequential_number) %>%
  dplyr::summarize(mean_REV = mean(FEV1_PCT_reversibility_postBD, na.rm = TRUE))
```

```{r, eval = FALSE}
# Join the dataset and the new mean variable for FeNO
imp_data_ORACLE_final_COMP_NR <- 
  left_join(imp_data_ORACLE_final_COMP_NR, patient_mean_FeNO_NR, by = "Sequential_number")
```

```{r, eval = FALSE}
# Join the dataset and the new mean variable for BEC
imp_data_ORACLE_final_COMP_NR <- 
  left_join(imp_data_ORACLE_final_COMP_NR, patient_mean_BEC_NR, by = "Sequential_number")
```

```{r, eval = FALSE}
# Join the dataset and the new mean variable for REV
imp_data_ORACLE_final_COMP_NR <- 
  left_join(imp_data_ORACLE_final_COMP_NR, patient_mean_REV_NR, by = "Sequential_number")
```

```{r, eval = FALSE}
# Create FeNO groups for the three curves in the spline plot
imp_data_ORACLE_final_COMP_NR <- imp_data_ORACLE_final_COMP_NR %>%
  mutate(FeNO_3groups_mean = case_when(
    mean_FeNO < 25 ~ "A",
    mean_FeNO >= 25 & mean_FeNO < 50 ~ "B",
    mean_FeNO >= 50 ~ "C"
  ))
```

```{r, eval = FALSE}
# Create a subset of one imputed dataset
subset1 <- subset(imp_data_ORACLE_final_COMP_NR, .imp == 1)
```

```{r, eval = FALSE}
# Load necessary library
library(MASS) # Provides glm.nb() for negative binomial models
library(rms)  # Provides rcs() for restricted cubic splines

# Fit a negative binomial regression model using the subset of data
model <- glm.nb(
  Number_severe_asthma_attacks_during_followup ~  # Outcome variable: Number of severe asthma attacks during follow-up
    rcs(mean_BEC, 4) * FeNO_3groups_mean +        # Main predictor: Restricted cubic spline (4 knots) for mean BEC
                                                  #               with interaction by FeNO group (3 categories)
    ACQ_baseline_score_mean +                     # Covariate: Asthma Control Questionnaire baseline mean score
    Any_severe_attack_previous_12m_0no_1yes +     # Covariate: Indicator for whether a severe attack occurred in the previous 12 months
    FEV1_preBD_PCT_Baseline +                     # Covariate: Baseline FEV1 % predicted pre-bronchodilator
    Treatment_step +                              # Covariate: Treatment step (categorical variable)
    FeNO_baseline_ppb *                            
    Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + # Covariate: Interaction between FeNO and Baseline Blood Eosinophil Count
    offset(Follow_up_duration_days) +             # Offset: Follow-up duration in days (log-transformed to account for exposure)
    as.factor(Enrolled_Trial_name),               # Covariate: Trial name (categorical variable)
  data = subset1                                  # Subset of data used for fitting the model
)

```


```{r, eval = FALSE}
# Load necessary library
library(ggplot2)

# Create a spline curve for BEC and FeNO using ggplot2
spline <- ggplot(
  data = subset1,                                    # Data: Use the subset1 dataset
  aes(
    x = mean_BEC,                                    # X-axis: Mean BEC (mean_BEC)
    y = predict(model, type = "response"),           # Y-axis: Predicted severe asthma attack rate based on the fitted model
    colour = FeNO_3groups_mean,                      # Line color: Different colors for each FeNO group
    fill = FeNO_3groups_mean                         # Fill color: Corresponds to FeNO groups
  )
) +
  geom_smooth(alpha = 0.3) +                         # Add a smooth curve with slight transparency
  xlab("Baseline BEC (x10^9 cells/L)") +             # X-axis label: Include units for clarity
  ylab("Estimated annualised Severe Asthma Attack Rate") + # Y-axis label: Explains the outcome variable
  scale_color_manual(
    values = c("green3", "orange2", "red3"),         # Custom colors for FeNO groups
    labels = c("<25", "25-50", "≥50"),               # Legend labels for FeNO groups
    name = "FeNO (ppb)"                              # Legend title
  ) +
  scale_fill_manual(
    values = c("green3", "orange2", "red3"),         # Same custom colors for the fill
    labels = c("<25", "25-50", "≥50"),               # Same legend labels
    name = "FeNO (ppb)"                              # Same legend title
  ) +
  scale_x_continuous(
    trans = "log",                                   # Log-transform the X-axis
    limits = c(0.1, 1.5),                            # Set axis limits to clinically logical values
    breaks = c(0.1, 0.15, 0.3, 0.6, 1, 1.5)          # Add specific tick marks for readability
  ) +
  scale_y_continuous(
    breaks = c(0.6, 1.0, 1.4, 1.8, 2.2)              # Add specific tick marks for the Y-axis
  ) +
  theme(                                             # Customize plot theme
    axis.text.x = element_text(face = "bold", size = 12), # Bold and slightly larger font for X-axis labels
    axis.text.y = element_text(face = "bold", size = 12), # Bold and slightly larger font for Y-axis labels
    axis.title = element_text(face = "bold", size = 12),  # Bold and slightly larger font for axis titles
    legend.title = element_text(face = "bold", size = 12),# Bold legend title
    legend.text = element_text(size = 12),                # Slightly larger font for legend text
    plot.title = element_text(face = "bold", size = 16),  # Bold, larger font for plot title
    panel.background = element_blank(),                   # Remove the background grid for a clean look
    panel.grid = element_line(colour = "#ebebeb"),        # Add light grid lines for clarity
    axis.line = element_line(colour = "black"),           # Black axis lines for better contrast
    legend.position = "top"                               # Move legend to the top of the plot
  ) +
  labs(title = "A")                                       # Add a title to the plot

# Save the plot as a PNG file
ggsave(
  "plot.png",                                             # File name
  spline,                                                 # Plot object to save
  width = 8,                                              # Plot width in inches
  height = 6,                                             # Plot height in inches
  units = "in",                                           # Units for dimensions
  dpi = 600                                               # High resolution (600 DPI)
)

```


```{r, eval = FALSE}
# Fit a negative binomial regression model using the subset of data
model_rev <- glm.nb(
  Number_severe_asthma_attacks_during_followup ~  # Outcome variable: Number of severe asthma attacks during follow-up
    rcs(mean_REV, 4) +                            # Main predictor: Restricted cubic spline (4 knots) for mean FEV1% reversibility
    ACQ_baseline_score_mean +                     # Covariate: Asthma Control Questionnaire baseline mean score
    Any_severe_attack_previous_12m_0no_1yes +     # Covariate: Indicator for severe asthma attack in the previous 12 months
    FEV1_preBD_PCT_Baseline +                     # Covariate: Baseline FEV1% predicted pre-bronchodilator
    Treatment_step +                              # Covariate: Treatment step (categorical variable)
    FeNO_baseline_ppb +                           # Covariate: Baseline Fractional Exhaled Nitric Oxide (continuous variable)
    Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + # Covariate: Baseline Blood Eosinophil Count (continuous variable)
    offset(Follow_up_duration_days) +             # Offset: Follow-up duration in days (log-transformed for exposure adjustment)
    as.factor(Enrolled_Trial_name),               # Covariate: Trial name as a categorical variable
  data = subset1                                  # Subset of data used for fitting the model
)

```


```{r, eval = FALSE}
# Create a spline curve for FEV1% reversibility using ggplot2

plot_fev_rev <- 
  ggplot(data = subset1, 
         aes(x = mean_REV, 
             y = predict(model_rev, type="response"))) +
  geom_smooth(fill="lightblue") +
  xlab("FEV1 Reversibility post-bronchodilator (%)") +
  ylab("Estimated annualised Severe Asthma Attack Rate") +
  scale_y_continuous(breaks=c(0.2,0.4,0.6,0.8,1.0,1.2)) +
  scale_x_continuous(limits=c(-10,90), 
                     breaks=c(-10,0,10,20,30,40,50,60,70,80,90)) +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 12),
        axis.text.y = element_text(face = "bold", 
                                   size = 12),
        axis.title = element_text(face = "bold", 
                                  size = 12),
        panel.background = element_blank(),
        panel.grid = element_line(colour = "#ebebeb"),
        axis.line = element_line(colour = "black"))

# Save the plot to files
ggsave("SPLINE PLOT FEV1 REV final new x label 07-10-2024.png", plot_fev_rev, width = 8, height = 6, units = "in", dpi = 600)
```

# Figure 3B & 3D: Density plots BEC FeNO & Density plot FEV1% reversibility

```{r, eval = FALSE}
# Load necessary library
library(ggplot2)

# Create a density plot for Blood Eosinophil Count (BEC) grouped by mean FeNO levels, without a legend
dens_bec_feno <- ggplot(subset1, 
                        aes(x = mean_BEC, 
                            fill = FeNO_3groups_mean)) + 
  geom_density(alpha = 0.4) +                              # Plot the density with 40% transparency for overlapping areas
  scale_fill_manual(values = c("A" = "green3", 
                                "B" = "orange2", 
                                "C" = "red3")) +           # Custom fill colors matching FeNO groups
  scale_x_continuous(trans = "log",                        # Log-transformed x-axis to better visualize BEC
                     limits = c(0.1, 1.5),                 # Set x-axis range on a clinically logical scale
                     breaks = c(0.1, 0.15, 0.3, 0.6, 1, 1.5)) + # Set specific ticks on x-axis
  labs(x = "Blood Eosinophil Count (x10^9 cells/L)",       # Label for x-axis
       y = "Probability density") +                        # Label for y-axis
  theme(axis.text.x = element_text(face = "bold", size = 12),  # Bold and size 12 for x-axis tick labels
        axis.text.y = element_text(face = "bold", size = 12),  # Bold and size 12 for y-axis tick labels
        axis.title = element_text(face = "bold", size = 12),   # Bold and size 12 for axis titles
        panel.background = element_blank(),                   # Remove background color
        panel.grid = element_line(colour = "#ebebeb"),        # Light grey grid lines
        axis.line = element_line(colour = "black"),           # Black axis lines
        legend.position = "none")                             # Remove legend

# Save the plot to a file
ggsave("20241017 Density plot BEC by FenO no legend v5.png", 
       dens_bec_feno, 
       width = 8, 
       height = 2, 
       units = "in", 
       dpi = 300)        # Save plot as PNG with specified dimensions and resolution

```


```{r, eval = FALSE}
# Create a density plot for FEV1% reversibility
dens_rev <- ggplot(subset1, 
                   aes(x = mean_REV)) + 
  geom_density(fill = "lightblue", alpha = 0.4) +         # Plot density with light blue fill and 40% transparency
  scale_x_continuous(limits = c(-10, 90),                 # Set x-axis range to match spline curve
                     breaks = seq(-10, 90, by = 10)) +    # Tick marks every 10 units on x-axis
  labs(x = "FEV1 Reversibility post-bronchodilator (%)",  # x-axis label
       y = "Probability density") +                       # y-axis label
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 12),
        axis.text.y = element_text(face = "bold", 
                                   size = 12),
        axis.title = element_text(face = "bold", 
                                  size = 12),
        panel.background = element_blank(),
        panel.grid = element_line(colour = "#ebebeb"),
        axis.line = element_line(colour = "black"))

# Save the plot to a file
ggsave("20241017 Density plot FEV1 rev v6.png", 
       dens_rev, 
       width = 8, 
       height = 2, 
       units = "in", 
       dpi = 300)     # Save plot as PNG

```


# Figure S11

```{r, eval = FALSE}
# Subset data to exclude specific trials
subset_noenrich <- subset(subset1, 
                          Enrolled_Trial_name %in% c("Novel_START", "PRACTICAL", "CAPTAIN", 
                                                     "DRI12544", "LAVOLTA_1", "LAVOLTA_2", 
                                                     "LUTE", "VERSE", "MILLY", "PACT", 
                                                     "QUEST", "STRATOS_1", "STRATOS_2"))

# Create a density plot for BEC grouped by FeNO levels, excluding enrichment trials
dens_bec_suppl <- ggplot(subset_noenrich, aes(x = mean_BEC, fill = FeNO_3groups_mean)) + 
  geom_density(alpha = 0.4) +                              # Plot density with 40% transparency
  scale_fill_manual(values = c("A" = "green3", 
                                "B" = "orange2", 
                                "C" = "red3"),             # Custom fill colors for FeNO groups
                    labels = c("<25", "25-50", "≥50")) +   # Labels for legend
  scale_x_continuous(trans = "log",                        # Log-transformed x-axis
                     limits = c(0.1, 1.5),                # x-axis range
                     breaks = c(0.1, 0.15, 0.3, 0.6, 1, 1.5)) + # Tick marks on x-axis
  labs(x = "Blood Eosinophil Count (x10^9 cells/L)",      # x-axis label
       y = "Probability density",                        # y-axis label
       fill = "FeNO (ppb)") +                             # Legend title
  theme(axis.text.x = element_text(face = "bold", size = 12),
        axis.text.y = element_text(face = "bold", size = 12),
        axis.title = element_text(face = "bold", size = 12),
        panel.background = element_blank(),
        panel.grid = element_line(colour = "#ebebeb"),
        axis.line = element_line(colour = "black"),
        legend.position = "top")                          # Position legend at the top

# Save the plot to a file
ggsave("20240718 Density plot BEC no enrichment with legend v3.png", dens_bec_suppl, 
       width = 8, height = 4, units = "in", dpi = 300)    # Save plot as PNG

```

```{r, eval = FALSE}
# Create a density plot for FEV1% reversibility using the data restricted to trials that required FEV1% reversibility data at baseline visit
dens_rev2 <- ggplot(subset1_rev, 
                    aes(x = mean_REV)) + 
  geom_density(fill = "lightblue", alpha = 0.4) +         # Plot density with light blue fill and 40% transparency
  scale_x_continuous(limits = c(-10, 90),                 # Set x-axis range to match spline curve
                     breaks = seq(-10, 90, by = 10)) +    # Tick marks every 10 units on x-axis
  labs(x = "FEV1 Reversibility post-bronchodilator (%)",  # x-axis label
       y = "Probability density") +                       # y-axis label
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 12),
        axis.text.y = element_text(face = "bold", 
                                   size = 12),
        axis.title = element_text(face = "bold", 
                                  size = 12),
        panel.background = element_blank(),
        panel.grid = element_line(colour = "#ebebeb"),
        axis.line = element_line(colour = "black"))

# Save the plot to a file
ggsave("20241007 Density plot FEV1 rev sensitivity v4.png", 
       dens_rev2, 
       width = 8, 
       height = 4, 
       units = "in", 
       dpi = 300)     # Save plot as PNG

```

# Figure S12

```{r, eval = FALSE}
# Fit a model for FeNO (separately from BEC) using the calculated mean
# See Figure 3A & 3B: Spline curve BEC FeNO & Spline curve FEV1% reversibility for a more detailed annotation
model_FeNO <- glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                  rcs(mean_FeNO, 3) +  # 3 knots for the spline
                  ACQ_baseline_score_mean + 
                  Any_severe_attack_previous_12m_0no_1yes +
                  FEV1_preBD_PCT_Baseline + 
                  Treatment_step + 
                  mean_BEC + 
                  offset(Follow_up_duration_days) + 
                  as.factor(Enrolled_Trial_name),  
                data = subset1)
```

```{r, eval = FALSE}
# Create a spline curve using ggplot2
# See Figure 3A & 3B: Spline curve BEC FeNO & Spline curve FEV1% reversibility for a more detailed annotation

plot_feno <- 
  ggplot(data = subset1, 
         aes(x = mean_FeNO, 
             y = predict(model_FeNO, type="response"))) +
  geom_smooth(color = "darkviolet", 
              fill="violet") +
  xlab("Baseline FeNO (ppb)") +
  ylab("Estimated annualised Severe Asthma Attack Rate") +
  scale_y_continuous(breaks=seq(0.4, 1.8, 
                                by = 0.1)) +
  scale_x_continuous(limits=c(5,200), 
                     breaks=c(5, 10, 
                              seq(20, 200, 
                                  by = 10))) +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 12),
        axis.text.y = element_text(face = "bold", 
                                   size = 12),
        axis.title = element_text(face = "bold", 
                                  size = 14),
        panel.background = element_blank(),
        panel.grid = element_line(colour = "#ebebeb"),
        axis.line = element_line(colour = "black"))

# Save the plot to files
ggsave("SPLINE PLOT FeNO final version 02-10-2024.png", 
       plot_feno, 
       width = 8, 
       height = 6, 
       units = "in", 
       dpi = 600)

```


```{r, eval = FALSE}
# Fit a model for BEC (separately from FeNO) using the calculated mean
# See Figure 3A & 3B: Spline curve BEC FeNO & Spline curve FEV1% reversibility for a more detailed annotation
model_bec <- glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                  rcs(mean_BEC, 3) + 
                  ACQ_baseline_score_mean + 
                  Any_severe_attack_previous_12m_0no_1yes +
                  FEV1_preBD_PCT_Baseline + 
                  Treatment_step + 
                  mean_FeNO + 
                  offset(Follow_up_duration_days) + 
                  as.factor(Enrolled_Trial_name),  
                data = subset1)
```

```{r, eval = FALSE}
# Create a spline curve using ggplot2
# See Figure 3A & 3B: Spline curve BEC FeNO & Spline curve FEV1% reversibility for a more detailed annotation

plot_bec <- 
  ggplot(data = subset1, 
         aes(x = mean_BEC, 
             y = predict(model_bec, type="response"))) +
  geom_smooth(color = "aquamarine3", 
              fill="aquamarine") +
  xlab("Baseline BEC (x10^9 cells/L)") +
  ylab("Estimated annualised Severe Asthma Attack Rate") +
  scale_y_continuous(breaks=seq(0.4, 1.8, 
                                by = 0.1)) +
  scale_x_continuous(limits=c(0.01, 1.5), 
                     breaks=c(0.01, 
                              seq(0.1, 1.5, 
                                  by = 0.1))) +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 12),
        axis.text.y = element_text(face = "bold", 
                                   size = 12),
        axis.title = element_text(face = "bold", 
                                  size = 14),
        panel.background = element_blank(),
        panel.grid = element_line(colour = "#ebebeb"),
        axis.line = element_line(colour = "black"))

# Save the plot to files
ggsave("SPLINE PLOT BEC final version 02-10-2024.png", 
       plot_bec, 
       width = 8, 
       height = 6, 
       units = "in", 
       dpi = 600)

```


# Figure S13

```{r, eval = FALSE}
# Restrict a subset of the data to studies that required FEV1% reversibility at baseline visit
subset1_rev <- subset(subset1, 
                      !(Enrolled_Trial_name %in% # Do NOT include the following trials:
                          c("CAPTAIN",                                                         
                            "DRI12544", 
                            "LAVOLTA_1", 
                            "LAVOLTA_2", 
                            "LUTE", 
                            "VERSE", 
                            "MILLY", 
                            "NAVIGATOR", 
                            "QUEST",
                            "STRATOS_1",
                            "STRATOS_2")))
```

```{r, eval = FALSE}
# Fit a model for FEV1% reversibility using the calculated mean
# See Figure 3A & 3B: Spline curve BEC FeNO & Spline curve FEV1% reversibility for a more detailed annotation
model_rev2 <- glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                      rcs(mean_REV, 4) + # 4 knots in the spline curve
                      ACQ_baseline_score_mean + 
                      Any_severe_attack_previous_12m_0no_1yes + 
                      FEV1_preBD_PCT_Baseline + 
                      Treatment_step + 
                      FeNO_baseline_ppb + 
                      Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                      offset(Follow_up_duration_days) + 
                      as.factor(Enrolled_Trial_name), 
                    data = subset1_rev)
```

```{r, eval = FALSE}
# Create a spline curve using ggplot2
# See Figure 3A & 3B: Spline curve BEC FeNO & Spline curve FEV1% reversibility for a more detailed annotation

plot_fev_rev2 <- 
  ggplot(data = subset1_rev, 
         aes(x = mean_REV, 
             y = predict(model_rev2, type="response"))) +
  geom_smooth(fill="lightblue") +
  xlab("FEV1 Reversibility post-bronchodilator (%)") +
  ylab("Estimated annualised Severe Asthma Attack Rate") +
  scale_y_continuous(breaks=c(0.2,0.4,0.6,0.8,1.0,1.2)) +
  scale_x_continuous(limits=c(-10,90), 
                     breaks=c(-10,0,10,20,30,40,50,60,70,80,90)) +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 12),
        axis.text.y = element_text(face = "bold", 
                                   size = 12),
        axis.title = element_text(face = "bold", 
                                  size = 12),
        panel.background = element_blank(),
        panel.grid = element_line(colour = "#ebebeb"),
        axis.line = element_line(colour = "black"))

# Save the plot to files
ggsave("SPLINE PLOT FEV1 REV sensitivity new x label 07-10-2024.png", 
       plot_fev_rev2, 
       width = 8, 
       height = 6, 
       units = "in", 
       dpi = 600)
```
